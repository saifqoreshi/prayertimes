<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Prayer Times – Gosheim</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root {
      --bg: #0b0f14;
      --card: #111722;
      --text: #e6edf3;
      --muted: #9fb0c0;
      --accent: #3aa3ff;
      --accent-2: #25c2a0;
      --warn: #ffb020;
      --danger: #ff4d6d;
      --border: #233044;
      --shadow: 0 8px 24px rgba(0,0,0,0.35);
      --radius: 14px;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f9fc;
        --card: #ffffff;
        --text: #111722;
        --muted: #445065;
        --accent: #0b66ff;
        --accent-2: #0b9f6a;
        --warn: #b36b00;
        --danger: #c1103a;
        --border: #e5eaf0;
        --shadow: 0 8px 24px rgba(17,23,34,0.08);
      }
    }
    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    * { box-sizing: border-box; }
    a { color: var(--accent); text-decoration: none; }
    .app {
      max-width: 680px;
      margin: 0 auto;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; padding: 10px 4px 18px;
    }
    .title {
      display: flex; flex-direction: column; gap: 4px;
    }
    .title h1 {
      margin: 0; font-size: 1.25rem; letter-spacing: 0.2px;
    }
    .title .sub {
      font-size: 0.9rem; color: var(--muted);
    }
    .date-row {
      display: grid; grid-template-columns: 1fr auto; gap: 10px;
      align-items: center; margin: 0 4px 14px;
    }
    .date-row input[type="date"] {
      width: 100%;
      background: var(--card); color: var(--text);
      border: 1px solid var(--border); border-radius: 10px;
      padding: 12px; box-shadow: var(--shadow);
    }
    .refresh-btn {
      background: var(--accent); color: white; border: none; border-radius: 10px;
      padding: 12px 14px; font-weight: 600; box-shadow: var(--shadow);
    }
    .settings {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow);
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;
    }
    .settings .field {
      display: flex; flex-direction: column; gap: 6px;
    }
    .settings label { color: var(--muted); font-size: 0.85rem; }
    .settings select {
      background: transparent; color: var(--text); border: 1px solid var(--border);
      border-radius: 10px; padding: 10px;
    }
    .countdown {
      background: linear-gradient(135deg, rgba(58,163,255,0.15), rgba(37,194,160,0.15));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      margin: 8px 0 16px;
      box-shadow: var(--shadow);
      display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;
    }
    .countdown .label {
      color: var(--muted); font-size: 0.9rem;
    }
    .countdown .value {
      font-size: 1.2rem; font-weight: 700;
    }
    .legend {
      display: flex; gap: 14px; align-items: center;
      color: var(--muted); font-size: 0.85rem; margin: 6px 2px 12px;
      flex-wrap: wrap;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .dot.current { background: var(--accent); }
    .dot.next { background: var(--accent-2); }
    .dot.passed { background: #506077; }
    table {
      width: 100%; border-collapse: collapse; overflow: hidden;
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow);
    }
    th, td {
      padding: 12px; border-bottom: 1px solid var(--border);
    }
    th {
      text-align: left; font-weight: 700; font-size: 0.9rem; color: var(--muted);
      position: sticky; top: 0; background: var(--card);
    }
    tr:last-child td { border-bottom: none; }
    .row {
      transition: background 0.2s ease, color 0.2s ease;
    }
    .row.passed { color: #8fa0b2; }
    .row.current { background: rgba(58,163,255,0.12); border-left: 3px solid var(--accent); }
    .row.next { background: rgba(37,194,160,0.12); border-left: 3px solid var(--accent-2); }
    .badge {
      font-size: 0.75rem; font-weight: 700; padding: 6px 8px; border-radius: 999px;
      border: 1px solid var(--border); color: var(--muted);
    }
    .badge.current { color: var(--accent); border-color: var(--accent); }
    .badge.next { color: var(--accent-2); border-color: var(--accent-2); }
    .footer {
      color: var(--muted); font-size: 0.85rem; padding: 16px 4px; text-align: center;
    }
    .error {
      background: rgba(255,77,109,0.12); border: 1px solid var(--danger);
      color: var(--danger); padding: 12px; border-radius: 12px; margin: 10px 2px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>Prayer times for Gosheim, Germany</h1>
        <div class="sub" id="gregorian"></div>
      </div>
      <div>
        <span class="badge" id="tzBadge">Time zone</span>
      </div>
    </header>

    <div class="date-row">
      <input type="date" id="dateInput" />
      <button class="refresh-btn" id="refreshBtn">Refresh</button>
    </div>

    <section class="settings" aria-label="Settings">
      <div class="field">
        <label for="methodSelect">Calculation method</label>
        <select id="methodSelect">
          <option value="3" selected>Muslim World League</option>
          <option value="2">Egyptian General Authority</option>
          <option value="1">University of Islamic Sciences, Karachi</option>
          <option value="4">Umm al-Qura, Makkah</option>
          <option value="5">Moonsighting Committee</option>
          <option value="12">Gulf Region</option>
        </select>
      </div>
      <div class="field">
        <label for="schoolSelect">Juristic school</label>
        <select id="schoolSelect">
          <option value="1" selected>Hanafi</option>
          <option value="0">Shafi</option>
        </select>
      </div>
    </section>

    <section class="countdown" aria-live="polite">
      <div>
        <div class="label">Next prayer</div>
        <div class="value" id="nextName">—</div>
      </div>
      <div>
        <div class="label">Time remaining</div>
        <div class="value" id="countdown">—</div>
      </div>
    </section>

    <div class="legend">
      <span><span class="dot current"></span>Current</span>
      <span><span class="dot next"></span>Next</span>
      <span><span class="dot passed"></span>Passed</span>
    </div>

    <div id="error" class="error" style="display:none;"></div>

    <table aria-label="Prayer times">
      <thead>
        <tr>
          <th style="width:40%;">Prayer</th>
          <th style="width:30%;">Time</th>
          <th style="width:30%;">Status</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Rows injected by JS -->
      </tbody>
    </table>

    <div class="footer" id="meta"></div>
  </div>

  <script>
    // Configuration
    const ADDRESS = "Gosheim, Germany";
    const PRAYER_ORDER = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"]; // We'll display Sunrise but skip it for "current/next" logic
    const PRAYER_FOR_STATUS = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"]; // exclude Sunrise

    const el = {
      dateInput: document.getElementById("dateInput"),
      refreshBtn: document.getElementById("refreshBtn"),
      methodSelect: document.getElementById("methodSelect"),
      schoolSelect: document.getElementById("schoolSelect"),
      tzBadge: document.getElementById("tzBadge"),
      gregorian: document.getElementById("gregorian"),
      nextName: document.getElementById("nextName"),
      countdown: document.getElementById("countdown"),
      tableBody: document.getElementById("tableBody"),
      error: document.getElementById("error"),
      meta: document.getElementById("meta"),
    };

    // Initialize date input with local date
    function pad(n){ return String(n).padStart(2, "0"); }
    function formatAPIDate(d) { // dd-mm-YYYY as per AlAdhan
      return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`;
    }
    function formatISODateForInput(d) {
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    const now = new Date();
    el.dateInput.value = formatISODateForInput(now);

    // Utilities
    function parseTimeToDate(baseDate, timeStr, tzOffsetMinutes) {
      // timeStr like "05:43"
      const [hh, mm] = timeStr.split(":").map(Number);
      const d = new Date(baseDate);
      d.setHours(hh, mm, 0, 0);
      // The API times are local to the location's timezone. We assume user's browser TZ ~= location TZ.
      // If api provides timezone, we can adjust by offset difference to user's current tz.
      if (typeof tzOffsetMinutes === "number") {
        const userOffset = -new Date().getTimezoneOffset();
        const diff = tzOffsetMinutes - userOffset;
        d.setMinutes(d.getMinutes() + diff);
      }
      return d;
    }

    function hms(ms) {
      if (ms < 0) ms = 0;
      const s = Math.floor(ms / 1000);
      const hh = Math.floor(s / 3600);
      const mm = Math.floor((s % 3600) / 60);
      const ss = s % 60;
      return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
    }

    function buildRow(name, time, status) {
      const tr = document.createElement("tr");
      tr.className = "row";
      if (status === "current") tr.classList.add("current");
      else if (status === "next") tr.classList.add("next");
      else if (status === "passed") tr.classList.add("passed");

      const tdName = document.createElement("td");
      tdName.textContent = name;

      const tdTime = document.createElement("td");
      tdTime.textContent = time;

      const tdStatus = document.createElement("td");
      const badge = document.createElement("span");
      badge.className = "badge " + (status || "");
      badge.textContent = status ? status.charAt(0).toUpperCase() + status.slice(1) : "—";
      tdStatus.appendChild(badge);

      tr.appendChild(tdName);
      tr.appendChild(tdTime);
      tr.appendChild(tdStatus);
      return tr;
    }

    function determineStatuses(baseDate, timings, tzOffsetMinutes) {
      const prayerTimes = {};
      PRAYER_ORDER.forEach(p => {
        const t = timings[p];
        if (t) {
          prayerTimes[p] = parseTimeToDate(baseDate, t, tzOffsetMinutes);
        }
      });
      const now = new Date();

      // Determine current and next among PRAYER_FOR_STATUS
      let current = null;
      let next = null;

      // Create ordered list of upcoming times with small epsilon windows
      for (let i = 0; i < PRAYER_FOR_STATUS.length; i++) {
        const p = PRAYER_FOR_STATUS[i];
        const t = prayerTimes[p];
        if (!t) continue;
        if (now >= t) {
          current = p; // last one passed becomes current until the next begins
        } else {
          next = p;
          break;
        }
      }
      // If all passed, next is tomorrow's Fajr (not fetched). We'll mark none and show Isha as current.
      if (!next) {
        next = null;
      }
      if (!current) {
        // Before Fajr: no prayer passed; set current to null and next to Fajr
        current = null;
      }

      const statuses = {};
      PRAYER_ORDER.forEach(p => {
        const t = prayerTimes[p];
        if (!t) { statuses[p] = null; return; }
        if (PRAYER_FOR_STATUS.includes(p)) {
          if (current === p && next) statuses[p] = "current";
          else if (next === p) statuses[p] = "next";
          else if (now > t) statuses[p] = "passed";
          else statuses[p] = null;
        } else {
          // Sunrise special: only show as passed/upcoming without "current/next"
          statuses[p] = now > t ? "passed" : null;
        }
      });

      return { statuses, prayerTimes, current, next };
    }

    function updateCountdown(nextDate) {
      if (!nextDate) {
        el.nextName.textContent = "—";
        el.countdown.textContent = "—";
        return;
      }
      el.nextName.textContent = nextDate.name;
      const tick = () => {
        const ms = nextDate.time - new Date();
        el.countdown.textContent = hms(ms);
      };
      tick();
      if (window.__countdownTimer) clearInterval(window.__countdownTimer);
      window.__countdownTimer = setInterval(tick, 1000);
    }

    async function loadTimings() {
      el.error.style.display = "none";
      el.tableBody.innerHTML = "";
      el.nextName.textContent = "—";
      el.countdown.textContent = "—";

      const date = new Date(el.dateInput.value + "T00:00:00");
      const apiDate = formatAPIDate(date);
      const method = el.methodSelect.value; // "3" for MWL by default
      const school = el.schoolSelect.value; // "1" for Hanafi by default

      const url = `https://api.aladhan.com/v1/timingsByAddress/${apiDate}?address=${encodeURIComponent(ADDRESS)}&method=${method}&school=${school}`;
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`Request failed (${res.status})`);
        const data = await res.json();

        const timings = data?.data?.timings || {};
        const meta = data?.data?.meta || {};
        const dateInfo = data?.data?.date || {};
        const timezone = meta?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
        const tzOffsetMinutes = (meta?.offset || null); // AlAdhan sometimes provides offset (minutes). If not, null.

        el.tzBadge.textContent = timezone || "Local time zone";
        el.gregorian.textContent = `${dateInfo?.gregorian?.weekday?.en || ""}, ${dateInfo?.readable || el.dateInput.value}`;

        // Determine statuses
        const { statuses, prayerTimes, current, next } = determineStatuses(date, timings, tzOffsetMinutes);

        // Build table rows in PRAYER_ORDER
        PRAYER_ORDER.forEach(p => {
          const time = timings[p];
          if (!time) return;
          const row = buildRow(p, time, statuses[p]);
          el.tableBody.appendChild(row);
        });

        // Countdown for next prayer (if exists)
        if (next && prayerTimes[next]) {
          updateCountdown({ name: next, time: prayerTimes[next] });
        } else {
          updateCountdown(null);
        }

        // Footer meta
        const metaBits = [];
        if (method === "3") metaBits.push("Method: Muslim World League");
        else metaBits.push(`Method ID: ${method}`);
        metaBits.push(school === "1" ? "School: Hanafi" : "School: Shafi");
        metaBits.push(`Location: ${ADDRESS}`);
        el.meta.textContent = metaBits.join(" • ");
      } catch (err) {
        el.error.textContent = `Could not retrieve timings. ${err.message}`;
        el.error.style.display = "block";
      }
    }

    // Events
    el.refreshBtn.addEventListener("click", loadTimings);
    el.methodSelect.addEventListener("change", loadTimings);
    el.schoolSelect.addEventListener("change", loadTimings);
    el.dateInput.addEventListener("change", loadTimings);

    // Auto-load on start and tick updates
    loadTimings();

    // Refresh statuses and countdown every 30 seconds (times unchanged, status may change)
    setInterval(() => {
      // Recompute statuses with last fetched data by reloading (simplest and correct across midnight)
      loadTimings();
    }, 30000);
  </script>
</body>
</html>
