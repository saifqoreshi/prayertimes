<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prayer Times – Gosheim, Germany</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root {
      --bg: #0b0f14;
      --card: #111722;
      --text: #e6edf3;
      --muted: #9fb0c0;
      --accent: #3aa3ff;
      --accent-2: #25c2a0;
      --border: #233044;
      --radius: 12px;
      --shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; }
    .app { max-width: 680px; margin: 0 auto; padding: 12px 16px 20px; }

    /* Sticky compact header */
    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 8px 12px;
    }
    .header-title { font-size: 1rem; font-weight: 700; text-align: center; margin: 0; }
    .header-dates {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    /* Date navigation + next prayer */
    .date-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0;
      gap: 10px;
    }
    .date-nav input[type="date"] {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      font-size: 0.9rem;
      width: 52%;
    }
    .next-box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 12px;
      text-align: center;
      box-shadow: var(--shadow);
      font-size: 0.85rem;
      width: 48%;
    }
    .next-box strong { display:block; font-size:0.8rem; color:var(--muted); }
    .next-box div { font-size:0.95rem; }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 14px;
    }
    th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: center; }
    th { color: var(--muted); font-size: 0.85rem; }
    tr:last-child td { border-bottom: none; }
    .row.current td:nth-child(2) { color: var(--accent); font-weight: 700; background: rgba(58,163,255,0.12); }
    .row.next td:nth-child(2) { color: var(--accent-2); font-weight: 700; background: rgba(37,194,160,0.12); }
    .indicator { display: block; font-size: 0.72rem; margin-top: 4px; }

    /* Ramadan widget */
    .ramadan-widget {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-top: 14px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    .ramadan-widget strong { color: var(--accent-2); }
    .ramadan-widget .sub { color: var(--muted); font-size: 0.9rem; }

    /* Footer */
    footer { text-align: center; margin-top: 16px; padding-bottom: 8px; }
    footer .powered { font-size: 0.7rem; color: var(--muted); }
    footer .meta { font-size: 0.6rem; color: #6b7890; margin-top: 4px; }

    /* Error */
    .error {
      color: #ff788a;
      background: rgba(255,77,109,0.12);
      border: 1px solid #ff4d6d;
      border-radius: 10px;
      padding: 8px;
      margin: 10px 0;
      display: none;
      text-align: center;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="header-title">Prayer times Gosheim Germany</div>
      <div class="header-dates">
        <span id="gregorian">—</span>
        <span id="hijri">—</span>
      </div>
    </header>

    <div id="error" class="error"></div>

    <div class="date-nav">
      <input type="date" id="dateInput" />
      <div class="next-box" aria-live="polite">
        <strong>Next prayer</strong>
        <div id="nextName">—</div>
        <strong>Countdown</strong>
        <div id="countdown">—</div>
      </div>
    </div>

    <table aria-label="Prayer times">
      <thead>
        <tr><th>Prayer</th><th>Time & Status</th></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <!-- Ramadan widget -->
    <div class="ramadan-widget" aria-live="polite">
      <div><strong>Days until Ramadan:</strong> <span id="ramadanCountdown">—</span></div>
      <div class="sub" id="ramadanDate">—</div>
    </div>

    <footer>
      <div class="powered">Powered by AlAdhan API</div>
      <div class="meta" id="meta">Method: Muslim World League • School: Hanafi</div>
    </footer>
  </div>

  <script>
    const ADDRESS = "Gosheim, Germany";
    const METHOD = "3";  // Muslim World League
    const SCHOOL = "1";  // Hanafi
    const PRAYER_ORDER = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"];
    const PRAYERS_FOR_STATUS = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];

    const el = {
      tableBody: document.getElementById("tableBody"),
      gregorian: document.getElementById("gregorian"),
      hijri: document.getElementById("hijri"),
      nextName: document.getElementById("nextName"),
      countdown: document.getElementById("countdown"),
      dateInput: document.getElementById("dateInput"),
      ramadanCountdown: document.getElementById("ramadanCountdown"),
      ramadanDate: document.getElementById("ramadanDate"),
      meta: document.getElementById("meta"),
      error: document.getElementById("error"),
    };

    function pad(n){ return String(n).padStart(2,"0"); }
    function formatAPIDate(d){ return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`; }
    function formatInputDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function parseTime(baseDate, timeStr){
      const [hh, mm] = timeStr.split(":").map(Number);
      const d = new Date(baseDate);
      d.setHours(hh, mm, 0, 0);
      return d;
    }
    function hms(ms){
      if(ms < 0) ms = 0;
      const s = Math.floor(ms / 1000);
      const hh = Math.floor(s / 3600), mm = Math.floor((s % 3600) / 60), ss = s % 60;
      return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
    }
    function buildRow(name, time, isCurrent, isNext){
      const tr = document.createElement("tr");
      tr.className = "row" + (isCurrent ? " current" : "") + (isNext ? " next" : "");
      const tdName = document.createElement("td"); tdName.textContent = name;
      const tdTime = document.createElement("td"); tdTime.textContent = time;
      if(isCurrent){ tdTime.innerHTML += `<span class="indicator">Current</span>`; }
      else if(isNext){ tdTime.innerHTML += `<span class="indicator">Next</span>`; }
      tr.appendChild(tdName); tr.appendChild(tdTime);
      return tr;
    }

    let countdownTimer = null;

    async function loadTimingsForDate(dateObj){
      try {
        el.error.style.display = "none";

        const apiDate = formatAPIDate(dateObj);
        const url = `https://api.aladhan.com/v1/timingsByAddress/${apiDate}?address=${encodeURIComponent(ADDRESS)}&method=${METHOD}&school=${SCHOOL}`;

        const res = await fetch(url);
        if(!res.ok) throw new Error(`API error ${res.status}`);
        const json = await res.json();
        const data = json?.data || {};
        const timings = data?.timings || {};
        const dateInfo = data?.date || {};
        const hijri = dateInfo?.hijri;

        // Header dates
        el.gregorian.textContent = dateInfo?.readable || "—";
        if(hijri && hijri.month) {
          el.hijri.textContent = `${hijri.day} ${hijri.month.en} ${hijri.year}`;
        } else {
          el.hijri.textContent = "—";
        }

        // Prayer Date objects
        const prayerDateMap = {};
        PRAYER_ORDER.forEach(p => {
          const t = timings[p];
          if(t) prayerDateMap[p] = parseTime(dateObj, t);
        });

        // Determine current and next (relative to now)
        const now = new Date();
        let current = null;
        let next = null;
        for(const p of PRAYERS_FOR_STATUS){
          const t = prayerDateMap[p];
          if(!t) continue;
          if(now >= t){
            current = p;        // last started prayer becomes current
          } else if(!next){
            next = p;           // first upcoming prayer
          }
        }

        // Build table
        el.tableBody.innerHTML = "";
        PRAYER_ORDER.forEach(p => {
          const time = timings[p];
          if(!time) return;
          const row = buildRow(p, time, p === current, p === next);
          el.tableBody.appendChild(row);
        });

        // Countdown (if next exists)
        if(countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
        if(next && prayerDateMap[next]) {
          el.nextName.textContent = next;
          const tick = () => {
            el.countdown.textContent = hms(prayerDateMap[next] - new Date());
          };
          tick();
          countdownTimer = setInterval(tick, 1000);
        } else {
          el.nextName.textContent = "—";
          el.countdown.textContent = "—";
        }

        // Ramadan widget
        await updateRamadanWidget(hijri);

        // Footer meta
        el.meta.textContent = "Method: Muslim World League • School: Hanafi";
      } catch (e) {
        el.error.textContent = `Could not load timings. ${e.message}`;
        el.error.style.display = "block";
      }
    }

    function parseDDMMYYYYtoDate(ddmmYYYY){
      const [dd, mm, yyyy] = ddmmYYYY.split("-").map(Number);
      return new Date(`${yyyy}-${pad(mm)}-${pad(dd)}T00:00:00`);
    }

    async function updateRamadanWidget(hijriInfo){
      try {
        const currentYear = parseInt(hijriInfo?.year, 10);
        const currentMonthNum = hijriInfo?.month?.number;
        const currentDay = parseInt(hijriInfo?.day, 10);

        let targetYear;
        if(!currentYear || typeof currentMonthNum !== "number" || isNaN(currentDay)) {
          targetYear = new Date().getFullYear();
        } else if(currentMonthNum < 9 || (currentMonthNum === 9 && currentDay < 1)) {
          targetYear = currentYear;
        } else {
          targetYear = currentYear + 1;
        }

        // Convert Hijri 1 Ramadan (month 9) to Gregorian via AlAdhan
        const hToGUrl = `https://api.aladhan.com/v1/hToG?date=1-9-${targetYear}`;
        const res = await fetch(hToGUrl);
        if(!res.ok) throw new Error(`Ramadan API error ${res.status}`);
        const json = await res.json();
        const gDateStr = json?.data?.gregorian?.date; // "DD-MM-YYYY"
        if(!gDateStr) throw new Error("Missing Ramadan date");

        const ramadanGregorian = parseDDMMYYYYtoDate(gDateStr);
        const today = new Date();
        const msPerDay = 86400000;
        const diffDays = Math.ceil((ramadanGregorian - today) / msPerDay);

        el.ramadanCountdown.textContent =
          diffDays > 0 ? diffDays :
          diffDays === 0 ? "Today" :
          "Started";
        // No "estimated" or "Gregorian" words
        el.ramadanDate.textContent = `Start: ${gDateStr} • 1-9-${targetYear} Hijri`;
      } catch (e) {
        el.ramadanCountdown.textContent = "—";
        el.ramadanDate.textContent = "Ramadan countdown unavailable";
      }
    }

    // Initialize date input to today (local)
    (function init() {
      const today = new Date();
      el.dateInput.value = formatInputDate(today);
      loadTimingsForDate(today);
    })();

    // Navigate between dates
    el.dateInput.addEventListener("change", () => {
      if(!el.dateInput.value) return;
      const d = new Date(el.dateInput.value + "T00:00:00");
      loadTimingsForDate(d);
    });
  </script>
</body>
</html>
