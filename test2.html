<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prayer Times – Gosheim, Germany</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root {
      --bg:#0b0f14; --card:#111722; --text:#e6edf3; --muted:#9fb0c0;
      --accent:#3aa3ff; --accent2:#25c2a0; --border:#233044; --radius:12px;
      --shadow:0 6px 18px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .app{max-width:820px;margin:0 auto;padding:14px 18px 28px}

    header{position:sticky;top:0;z-index:1000;background:var(--card);border-bottom:1px solid var(--border);box-shadow:var(--shadow);padding:12px;text-align:left}
    header h1{margin:0;font-size:1rem}
    header .sub{margin-top:6px;font-size:0.92rem;color:var(--muted)}

    .error{display:none;color:#ff788a;background:rgba(255,77,109,0.12);border:1px solid #ff4d6d;border-radius:10px;padding:8px;margin:10px 0;text-align:center;font-size:0.9rem}

    /* Date navigation with arrows */
    .date-nav{display:flex;align-items:center;gap:8px;justify-content:center;margin:12px 0}
    .date-nav button{
      background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600;
      box-shadow:var(--shadow);
    }
    .date-nav button:active{transform:scale(0.98)}
    .date-nav input[type="date"]{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px;font-size:0.95rem}

    .next-row{display:flex;justify-content:space-between;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:12px;box-shadow:var(--shadow)}
    .next-row .label{font-size:0.85rem;color:var(--muted)}
    .next-row .value{font-size:1rem;font-weight:700}

    table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:14px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:center;font-size:0.9rem}
    th{color:var(--muted);background:#0f1623}
    tr:last-child td{border-bottom:none}
    .row.current td:nth-child(2){color:var(--accent);font-weight:700;background:rgba(58,163,255,0.08)}
    .row.next td:nth-child(2){color:var(--accent2);font-weight:700;background:rgba(37,194,160,0.08)}
    .indicator{display:block;font-size:0.72rem;margin-top:4px;color:var(--muted)}

    .ramadan-widget{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-top:14px;text-align:center;box-shadow:var(--shadow)}
    .ramadan-widget strong{color:var(--accent2)}
    .ramadan-widget .sub{color:var(--muted);font-size:0.9rem}

    .calendar-toggle{text-align:center;margin:12px 0}
    .calendar-toggle button{
      background:var(--card);
      color:var(--text);
      border:2px solid var(--accent);
      border-radius:var(--radius);
      padding:10px 18px;
      cursor:pointer;
      font-size:0.95rem;
      font-weight:600;
      box-shadow:var(--shadow);
      transition:background 0.25s,color 0.25s,border-color 0.25s,transform 0.1s;
    }
    .calendar-toggle button:hover{background:var(--accent);color:#fff;border-color:var(--accent2)}
    .calendar-toggle button:active{transform:scale(0.98)}

    .calendar-container{display:none;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-top:16px;box-shadow:var(--shadow);max-height:460px;overflow:auto}
    .calendar-header{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:10px}
    .calendar-header select{background:transparent;color:var(--text);border:1px solid var(--border);padding:8px;border-radius:8px}
    .calendar-container h2{font-size:0.95rem;margin:0 0 8px;color:var(--accent);text-align:center}
    .calendar-table{width:100%;border-collapse:collapse}
    .calendar-table th,.calendar-table td{padding:8px;border-bottom:1px solid var(--border);font-size:0.85rem;text-align:center}
    .calendar-table th{color:var(--muted);background:#0f1623}
    .calendar-table tr:last-child td{border-bottom:none}
    .cal-today{background:rgba(58,163,255,0.12)}

    .calendar-legend{font-size:0.78rem;color:var(--muted);text-align:center;margin-top:8px}

    footer{text-align:center;margin-top:16px;padding-bottom:8px}
    footer .powered{font-size:0.7rem;color:var(--muted)}
    footer .meta{font-size:0.6rem;color:#6b7890;margin-top:6px}
    /* Responsive */
    @media (max-width:520px){
      .next-row{flex-direction:column;gap:8px;align-items:flex-start}
      .date-nav{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Prayer times for Gosheim, Germany</h1>
      <div class="sub" id="gregorian">—</div>
      <div class="sub" id="hijri">—</div>
    </header>

    <div id="error" class="error" role="alert"></div>

    <div class="date-nav" aria-label="Date navigation">
      <button id="prevDay" title="Previous day">&larr;</button>
      <input type="date" id="dateInput" aria-label="Select date" />
      <button id="nextDay" title="Next day">&rarr;</button>
    </div>

    <div class="next-row" aria-live="polite">
      <div>
        <span class="label">Next prayer</span>
        <div class="value" id="nextName">—</div>
      </div>
      <div>
        <span class="label">Countdown</span>
        <div class="value" id="countdown">—</div>
      </div>
    </div>

    <table aria-label="Prayer times for selected date">
      <thead><tr><th>Prayer</th><th>Time & Status</th></tr></thead>
      <tbody id="tableBody"></tbody>
    </table>

    <div class="ramadan-widget" aria-live="polite">
      <div><strong>Days until Ramadan:</strong> <span id="ramadanCountdown">—</span></div>
      <div class="sub" id="ramadanDate">—</div>
    </div>

    <div class="calendar-toggle">
      <button id="toggleCalendar">Show Monthly Calendar</button>
    </div>

    <div class="calendar-container" id="calendarContainer" aria-hidden="true">
      <h2>Monthly Prayer Calendar</h2>
      <div class="calendar-header">
        <label for="monthSelect" class="visually-hidden">Month</label>
        <select id="monthSelect" aria-label="Select month"></select>
        <label for="yearSelect" class="visually-hidden">Year</label>
        <select id="yearSelect" aria-label="Select year"></select>
        <button id="loadMonthBtn" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer">Load</button>
      </div>
      <table class="calendar-table" id="calendarTable" aria-label="Monthly prayer times">
        <thead>
          <tr><th>Date</th><th>Fajr</th><th>Dhuhr</th><th>Asr</th><th>Maghrib</th><th>Isha</th></tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
      <div class="calendar-legend">Times are in 12-hour format (hours shown without AM/PM).</div>
    </div>

    <footer>
      <div class="powered">Powered by AlAdhan API</div>
      <div class="meta" id="meta">Method: Muslim World League • School: Hanafi</div>
    </footer>
  </div>

  <script>
    // Config
    const ADDRESS = "Gosheim, Germany";
    const METHOD = "3"; // Muslim World League
    const SCHOOL = "1"; // Hanafi
    const PRAYER_ORDER = ["Fajr","Sunrise","Dhuhr","Asr","Maghrib","Isha"];
    const PRAYERS_FOR_STATUS = ["Fajr","Dhuhr","Asr","Maghrib","Isha"];

    // Elements
    const el = {
      tableBody: document.getElementById("tableBody"),
      gregorian: document.getElementById("gregorian"),
      hijri: document.getElementById("hijri"),
      nextName: document.getElementById("nextName"),
      countdown: document.getElementById("countdown"),
      dateInput: document.getElementById("dateInput"),
      ramadanCountdown: document.getElementById("ramadanCountdown"),
      ramadanDate: document.getElementById("ramadanDate"),
      meta: document.getElementById("meta"),
      error: document.getElementById("error"),
      toggleBtn: document.getElementById("toggleCalendar"),
      calContainer: document.getElementById("calendarContainer"),
      monthSelect: document.getElementById("monthSelect"),
      yearSelect: document.getElementById("yearSelect"),
      loadMonthBtn: document.getElementById("loadMonthBtn"),
      calendarBody: document.getElementById("calendarBody"),
      prevDay: document.getElementById("prevDay"),
      nextDay: document.getElementById("nextDay"),
    };

    // Utilities
    const pad = n => String(n).padStart(2, "0");
    const formatAPIDate = d => `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`;
    const formatInputDate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const stripTZ = s => !s ? "—" : s.split(" ")[0]; // remove timezone suffix like " (CET)"

    // Convert "HH:MM" to 12-hour string with NO suffix (user requested no AM/PM in monthly calendar)
    function to12NoSuffix(timeStr){
      if(!timeStr || timeStr === "—") return "—";
      const [hhStr, mmStr] = timeStr.split(":");
      let hh = parseInt(hhStr, 10);
      const mm = mmStr;
      hh = hh % 12;
      if(hh === 0) hh = 12;
      return `${hh}:${mm}`;
    }

    // Convert "HH:MM" to 12-hour with AM/PM for daily view
    function toAmPm(timeStr){
      if(!timeStr || timeStr==="—") return "—";
      const [hhStr, mmStr] = timeStr.split(":");
      let hh = parseInt(hhStr, 10);
      const mm = mmStr;
      const suffix = hh >= 12 ? "PM" : "AM";
      hh = hh % 12; if(hh === 0) hh = 12;
      return `${hh}:${mm} ${suffix}`;
    }

    // Parse "HH:MM" into Date on baseDate
    function parseTime(baseDate, timeStr){
      const [hh, mm] = timeStr.split(":").map(Number);
      const d = new Date(baseDate);
      d.setHours(hh, mm, 0, 0);
      return d;
    }

    // hms countdown
    function hms(ms){
      if(ms < 0) ms = 0;
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const ss = s%60;
      return `${pad(h)}:${pad(m)}:${pad(ss)}`;
    }

    // Build daily table rows
    function buildRow(name,time24,isCurrent,isNext){
      const time12 = toAmPm(time24);
      const tr = document.createElement("tr");
      tr.className = "row" + (isCurrent ? " current" : "") + (isNext ? " next" : "");
      const td1 = document.createElement("td"); td1.textContent = name;
      const td2 = document.createElement("td"); td2.textContent = time12;
      if(isCurrent) td2.innerHTML += `<span class="indicator">Current</span>`;
      else if(isNext) td2.innerHTML += `<span class="indicator">Next</span>`;
      tr.append(td1, td2);
      return tr;
    }

    // Ramadan widget
    async function updateRamadanWidget(hijriInfo){
      try{
        const y = parseInt(hijriInfo?.year,10);
        const m = hijriInfo?.month?.number;
        const d = parseInt(hijriInfo?.day,10);
        let target = (!isNaN(y) && typeof m==="number" && !isNaN(d))
          ? (m < 9 || (m === 9 && d < 1) ? y : y + 1)
          : new Date().getFullYear();
        const r = await fetch(`https://api.aladhan.com/v1/hToG?date=1-9-${target}`);
        if(!r.ok) throw new Error(`Ramadan API ${r.status}`);
        const g = (await r.json())?.data?.gregorian?.date; // DD-MM-YYYY
        if(!g) throw new Error("Missing Ramadan date");
        const parts = g.split("-");
        const ramG = new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00`);
        const diff = Math.ceil((ramG - new Date())/86400000);
        el.ramadanCountdown.textContent = diff > 0 ? diff : diff === 0 ? "Today" : "Started";
        el.ramadanDate.textContent = `Start: ${g} • 1-9-${target} Hijri`;
      }catch(e){
        el.ramadanCountdown.textContent="—";
        el.ramadanDate.textContent="Ramadan countdown unavailable";
      }
    }

    // Load daily timings and update UI
    let countdownTimer = null;
    async function loadDaily(dateObj){
      try{
        el.error.style.display = "none";
        const r = await fetch(`https://api.aladhan.com/v1/timingsByAddress/${formatAPIDate(dateObj)}?address=${encodeURIComponent(ADDRESS)}&method=${METHOD}&school=${SCHOOL}`);
        if(!r.ok) throw new Error(`API ${r.status}`);
        const payload = await r.json();
        const data = payload?.data || {};
        const timings = data.timings || {};
        const dateInfo = data.date || {};
        const hijri = dateInfo.hijri;

        // Header
        el.gregorian.textContent = dateInfo.readable || "—";
        el.hijri.textContent = hijri && hijri.month ? `Hijri: ${hijri.day} ${hijri.month.en} ${hijri.year}` : "Hijri: —";

        // Build Date map and find current/next
        const tMap = {};
        PRAYER_ORDER.forEach(p=>{
          const t24 = stripTZ(timings[p]);
          if(t24 && t24 !== "—") tMap[p] = parseTime(dateObj, t24);
        });

        const now = new Date(); let current=null, next=null;
        for(const p of PRAYERS_FOR_STATUS){
          const t = tMap[p]; if(!t) continue;
          if(now >= t) current = p; else if(!next) next = p;
        }

        // Table
        el.tableBody.innerHTML = "";
        PRAYER_ORDER.forEach(p=>{
          const t24 = stripTZ(timings[p]);
          if(!t24) return;
          el.tableBody.appendChild(buildRow(p, t24, p===current, p===next));
        });

        // Countdown
        if(countdownTimer) clearInterval(countdownTimer);
        if(next && tMap[next]){
          el.nextName.textContent = next;
          const target = tMap[next];
          const tick = () => {
            const diff = target - new Date();
            if(diff <= 0){
              el.countdown.textContent = "00:00:00";
              clearInterval(countdownTimer);
              // no audio; just keep countdown at zeros
            } else {
              el.countdown.textContent = hms(diff);
            }
          };
          tick();
          countdownTimer = setInterval(tick, 1000);
        }else{
          el.nextName.textContent = "—";
          el.countdown.textContent = "—";
        }

        // Footer meta
        el.meta.textContent = "Method: Muslim World League • School: Hanafi";

        // Ramadan widget
        updateRamadanWidget(hijri);
      }catch(e){
        el.error.textContent = `Could not load timings. ${e.message||e}`;
        el.error.style.display = "block";
      }
    }

    // Load monthly calendar for given month/year
    async function loadMonthlyFor(month, year, highlightDate){
      try{
        el.calendarBody.innerHTML = "";
        const r = await fetch(`https://api.aladhan.com/v1/calendarByAddress?address=${encodeURIComponent(ADDRESS)}&method=${METHOD}&school=${SCHOOL}&month=${month}&year=${year}`);
        if(!r.ok) throw new Error(`Calendar API ${r.status}`);
        const payload = await r.json();
        const days = payload?.data || [];
        const highlightStr = highlightDate ? `${pad(highlightDate)}-${pad(month)}-${year}` : null;

        days.forEach(day=>{
          const gr = day?.date?.gregorian?.date || ""; // DD-MM-YYYY
          const readable = day?.date?.readable || "";
          const t = day?.timings || {};
          const tr = document.createElement("tr");
          if(gr === highlightStr) tr.classList.add("cal-today");
          const cells = [
            readable,
            to12NoSuffix(stripTZ(t.Fajr)),
            to12NoSuffix(stripTZ(t.Dhuhr)),
            to12NoSuffix(stripTZ(t.Asr)),
            to12NoSuffix(stripTZ(t.Maghrib)),
            to12NoSuffix(stripTZ(t.Isha)),
          ];
          cells.forEach(val => { const td = document.createElement("td"); td.textContent = val; tr.appendChild(td); });
          el.calendarBody.appendChild(tr);
        });
      }catch(e){
        el.calendarBody.innerHTML = `<tr><td colspan="6">Monthly calendar unavailable</td></tr>`;
      }
    }

    // Helpers to populate month & year selects
    function populateMonthYearSelects(initialDate){
      const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      el.monthSelect.innerHTML = "";
      monthNames.forEach((m, i) => {
        const opt = document.createElement("option");
        opt.value = i+1;
        opt.textContent = m;
        el.monthSelect.appendChild(opt);
      });

      const currentYear = new Date().getFullYear();
      el.yearSelect.innerHTML = "";
      for(let y = currentYear - 2; y <= currentYear + 2; y++){
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        el.yearSelect.appendChild(opt);
      }

      el.monthSelect.value = initialDate.getMonth()+1;
      el.yearSelect.value = initialDate.getFullYear();
    }

    // Toggle calendar visible/hidden
    el.toggleBtn.addEventListener("click", ()=>{
      const show = el.calContainer.style.display !== "block";
      el.calContainer.style.display = show ? "block" : "none";
      el.calContainer.setAttribute("aria-hidden", show ? "false" : "true");
      el.toggleBtn.textContent = show ? "Hide Monthly Calendar" : "Show Monthly Calendar";
      // If showing, ensure calendar is loaded for current selects
      if(show){
        const month = parseInt(el.monthSelect.value, 10);
        const year = parseInt(el.yearSelect.value, 10);
        const selectedDate = new Date(el.dateInput.value + "T00:00:00");
        loadMonthlyFor(month, year, selectedDate.getDate());
      }
    });

    // When load month button clicked or selects changed, load calendar
    el.loadMonthBtn.addEventListener("click", ()=>{
      const month = parseInt(el.monthSelect.value, 10);
      const year = parseInt(el.yearSelect.value, 10);
      const selectedDate = new Date(el.dateInput.value + "T00:00:00");
      loadMonthlyFor(month, year, selectedDate.getFullYear()===year && (selectedDate.getMonth()+1)===month ? selectedDate.getDate() : null);
    });

    // Prev/Next day buttons
    function changeSelectedDateBy(days){
      if(!el.dateInput.value) return;
      const d = new Date(el.dateInput.value + "T00:00:00");
      d.setDate(d.getDate() + days);
      el.dateInput.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      onDateChange();
    }
    el.prevDay.addEventListener("click", ()=> changeSelectedDateBy(-1));
    el.nextDay.addEventListener("click", ()=> changeSelectedDateBy(1));

    // When date changed (by input or arrows)
    async function onDateChange(){
      if(!el.dateInput.value) return;
      const selected = new Date(el.dateInput.value + "T00:00:00");
      await loadDaily(selected);
      // When monthly calendar is visible, reload for selected month/year if matches or highlight selected date
      if(el.calContainer.style.display === "block"){
        const month = parseInt(el.monthSelect.value, 10);
        const year = parseInt(el.yearSelect.value, 10);
        if(selected.getFullYear() === year && (selected.getMonth()+1) === month){
          loadMonthlyFor(month, year, selected.getDate());
        } else {
          // optionally update selects to match selected date
          el.monthSelect.value = selected.getMonth()+1;
          el.yearSelect.value = selected.getFullYear();
          loadMonthlyFor(selected.getMonth()+1, selected.getFullYear(), selected.getDate());
        }
      }
    }

    // Init: set date input to today, populate month/year selects, load daily & monthly
    (function init(){
      const today = new Date();
      el.dateInput.value = formatInputDate(today);
      populateMonthYearSelects(today);
      loadDaily(today);
      // don't auto-show calendar, but prepare calendar data for current month
      // (calendar is loaded when user toggles it or presses Load)
      // prefetch calendar for smoother UX
      loadMonthlyFor(today.getMonth()+1, today.getFullYear(), today.getDate());
    })();

    // Date input change handler
    el.dateInput.addEventListener("change", onDateChange);

    // Also allow pressing Enter in selects to load
    el.monthSelect.addEventListener("change", ()=>{/*no-op until Load pressed or toggle shows*/});
    el.yearSelect.addEventListener("change", ()=>{/*no-op until Load pressed or toggle shows*/});
  </script>
</body>
</html>