<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prayer Times – Gosheim, Germany</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root {
      --bg: #0b0f14;
      --card: #111722;
      --text: #e6edf3;
      --muted: #9fb0c0;
      --accent: #3aa3ff;
      --accent-2: #25c2a0;
      --border: #233044;
      --radius: 12px;
      --shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; }
    .app { max-width: 740px; margin: 0 auto; padding: 12px 16px 24px; }

    /* Header: three separate lines */
    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 10px;
      text-align: center;
    }
    header h1 { font-size: 1rem; margin: 0; }
    header .sub { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }

    /* Error banner */
    .error {
      color: #ff788a;
      background: rgba(255,77,109,0.12);
      border: 1px solid #ff4d6d;
      border-radius: 10px;
      padding: 8px;
      margin: 10px 0;
      display: none;
      text-align: center;
      font-size: 0.9rem;
    }

    /* Date navigation */
    .date-nav { text-align: center; margin: 12px 0; }
    .date-nav input[type="date"] {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      font-size: 0.9rem;
    }

    /* Next prayer row (left/right aligned) */
    .next-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
    }
    .next-row .label { font-size: 0.85rem; color: var(--muted); }
    .next-row .value { font-size: 1rem; font-weight: 600; transition: opacity 0.2s ease; }

    /* Day progress bar (Fajr → Isha) */
    .progress-container {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 14px;
      padding: 8px;
      box-shadow: var(--shadow);
    }
    .progress-label { font-size: 0.85rem; color: var(--muted); margin-bottom: 6px; }
    .progress-bar { width: 100%; height: 10px; background: #233044; border-radius: 6px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent-2); width: 0%; transition: width 0.7s ease; }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 14px;
      overflow: hidden;
    }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: center; font-size: 0.88rem; }
    th { color: var(--muted); background: #0f1623; position: sticky; top: 0; }
    tr:last-child td { border-bottom: none; }
    .row.current td:nth-child(2) { color: var(--accent); font-weight: 700; background: rgba(58,163,255,0.12); }
    .row.next td:nth-child(2) { color: var(--accent-2); font-weight: 700; background: rgba(37,194,160,0.12); }
    .indicator { display: block; font-size: 0.72rem; margin-top: 4px; }

    /* Ramadan widget */
    .ramadan-widget {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-top: 14px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    .ramadan-widget strong { color: var(--accent-2); }
    .ramadan-widget .sub { color: var(--muted); font-size: 0.9rem; }

    /* Monthly calendar */
    .calendar-container {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-top: 16px;
      box-shadow: var(--shadow);
      max-height: 360px;
      overflow-y: auto;
    }
    .calendar-container h2 {
      font-size: 0.95rem; margin: 0 0 8px; color: var(--accent); text-align: center;
    }
    .calendar-table { width: 100%; border-collapse: collapse; }
    .calendar-table th, .calendar-table td {
      padding: 8px; border-bottom: 1px solid var(--border); font-size: 0.82rem; text-align: center;
    }
    .calendar-table th { color: var(--muted); background: #0f1623; position: sticky; top: 0; }
    .calendar-table tr:last-child td { border-bottom: none; }
    .cal-today { background: rgba(58,163,255,0.12); }

    /* Footer */
    footer { text-align: center; margin-top: 16px; padding-bottom: 8px; }
    footer .powered { font-size: 0.7rem; color: var(--muted); }
    footer .meta { font-size: 0.6rem; color: #6b7890; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Prayer times for Gosheim, Germany</h1>
      <div class="sub" id="gregorian">—</div>
      <div class="sub" id="hijri">—</div>
    </header>

    <div id="error" class="error"></div>

    <div class="date-nav">
      <input type="date" id="dateInput" />
    </div>

    <div class="next-row" aria-live="polite">
      <div>
        <span class="label">Next prayer</span>
        <div class="value" id="nextName">—</div>
      </div>
      <div>
        <span class="label">Countdown</span>
        <div class="value" id="countdown">—</div>
      </div>
    </div>

    <div class="progress-container">
      <div class="progress-label">Day progress (Fajr → Isha)</div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>

    <table aria-label="Prayer times">
      <thead><tr><th>Prayer</th><th>Time & Status</th></tr></thead>
      <tbody id="tableBody"></tbody>
    </table>

    <div class="ramadan-widget" aria-live="polite">
      <div><strong>Days until Ramadan:</strong> <span id="ramadanCountdown">—</span></div>
      <div class="sub" id="ramadanDate">—</div>
    </div>

    <div class="calendar-container">
      <h2>Monthly Prayer Calendar</h2>
      <table class="calendar-table" id="calendarTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Fajr</th>
            <th>Dhuhr</th>
            <th>Asr</th>
            <th>Maghrib</th>
            <th>Isha</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>
      <div class="powered">Powered by AlAdhan API</div>
      <div class="meta" id="meta">Method: Muslim World League • School: Hanafi</div>
    </footer>
  </div>

  <script>
    // Config
    const ADDRESS = "Gosheim, Germany";
    const METHOD = "3";  // Muslim World League
    const SCHOOL = "1";  // Hanafi
    const PRAYER_ORDER = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"];
    const PRAYERS_FOR_STATUS = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];

    // Elements
    const el = {
      tableBody: document.getElementById("tableBody"),
      gregorian: document.getElementById("gregorian"),
      hijri: document.getElementById("hijri"),
      nextName: document.getElementById("nextName"),
      countdown: document.getElementById("countdown"),
      dateInput: document.getElementById("dateInput"),
      ramadanCountdown: document.getElementById("ramadanCountdown"),
      ramadanDate: document.getElementById("ramadanDate"),
      meta: document.getElementById("meta"),
      error: document.getElementById("error"),
      progressFill: document.getElementById("progressFill"),
      calendarTbody: document.querySelector("#calendarTable tbody"),
    };

    // Helpers
    function pad(n){ return String(n).padStart(2,"0"); }
    function formatAPIDate(d){ return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`; }
    function formatInputDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function parseTime(baseDate, timeStr){
      const [hh, mm] = timeStr.split(":").map(Number);
      const d = new Date(baseDate);
      d.setHours(hh, mm, 0, 0);
      return d;
    }
    function hms(ms){
      if(ms < 0) ms = 0;
      const s = Math.floor(ms / 1000);
      const hh = Math.floor(s / 3600), mm = Math.floor((s % 3600) / 60), ss = s % 60;
      return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
    }
    function buildRow(name, time, isCurrent, isNext){
      const tr = document.createElement("tr");
      tr.className = "row" + (isCurrent ? " current" : "") + (isNext ? " next" : "");
      const tdName = document.createElement("td"); tdName.textContent = name;
      const tdTime = document.createElement("td"); tdTime.textContent = time;
      if(isCurrent){ tdTime.innerHTML += `<span class="indicator">Current</span>`; }
      else if(isNext){ tdTime.innerHTML += `<span class="indicator">Next</span>`; }
      tr.appendChild(tdName); tr.appendChild(tdTime);
      return tr;
    }
    function parseDDMMYYYYtoDate(ddmmYYYY){
      const [dd, mm, yyyy] = ddmmYYYY.split("-").map(Number);
      return new Date(`${yyyy}-${pad(mm)}-${pad(dd)}T00:00:00`);
    }

    // Ramadan widget (no "estimated"/"Gregorian" wording)
    async function updateRamadanWidget(hijriInfo){
      try {
        const currentYear = parseInt(hijriInfo?.year, 10);
        const currentMonthNum = hijriInfo?.month?.number;
        const currentDay = parseInt(hijriInfo?.day, 10);
        let targetYear;
        if(!currentYear || typeof currentMonthNum !== "number" || isNaN(currentDay)) {
          targetYear = new Date().getFullYear();
        } else if(currentMonthNum < 9 || (currentMonthNum === 9 && currentDay < 1)) {
          targetYear = currentYear;
        } else {
          targetYear = currentYear + 1;
        }

        const res = await fetch(`https://api.aladhan.com/v1/hToG?date=1-9-${targetYear}`);
        if(!res.ok) throw new Error(`Ramadan API ${res.status}`);
        const json = await res.json();
        const gDateStr = json?.data?.gregorian?.date; // DD-MM-YYYY
        if(!gDateStr) throw new Error("Missing Ramadan date");

        const ramadanGregorian = parseDDMMYYYYtoDate(gDateStr);
        const today = new Date();
        const diffDays = Math.ceil((ramadanGregorian - today) / 86400000);

        el.ramadanCountdown.textContent =
          diffDays > 0 ? diffDays :
          diffDays === 0 ? "Today" : "Started";
        el.ramadanDate.textContent = `Start: ${gDateStr} • 1-9-${targetYear} Hijri`;
      } catch (e) {
        el.ramadanCountdown.textContent = "—";
        el.ramadanDate.textContent = "Ramadan countdown unavailable";
      }
    }

    // Progress bar update (between Fajr and Isha)
    function updateProgressBar(prayerMap){
      const fajr = prayerMap["Fajr"];
      const isha = prayerMap["Isha"];
      if(!fajr || !isha){ el.progressFill.style.width = "0%"; return; }
      const now = new Date();
      const start = fajr.getTime();
      const end = isha.getTime();
      if(now.getTime() <= start){ el.progressFill.style.width = "0%"; return; }
      if(now.getTime() >= end){ el.progressFill.style.width = "100%"; return; }
      const pct = ((now.getTime() - start) / (end - start)) * 100;
      el.progressFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    }

    let countdownTimer = null;
    let progressTimer = null;

    // Load daily timings
    async function loadTimingsForDate(dateObj){
      try {
        el.error.style.display = "none";

        const apiDate = formatAPIDate(dateObj);
        const url = `https://api.aladhan.com/v1/timingsByAddress/${apiDate}?address=${encodeURIComponent(ADDRESS)}&method=${METHOD}&school=${SCHOOL}`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`API error ${res.status}`);
        const json = await res.json();
        const data = json?.data || {};
        const timings = data?.timings || {};
        const dateInfo = data?.date || {};
        const hijri = dateInfo?.hijri;

        // Header dates
        el.gregorian.textContent = dateInfo?.readable || "—";
        if(hijri && hijri.month) {
          el.hijri.textContent = `Hijri: ${hijri.day} ${hijri.month.en} ${hijri.year}`;
        } else {
          el.hijri.textContent = "Hijri: —";
        }

        // Build Date objects
        const prayerMap = {};
        PRAYER_ORDER.forEach(p => {
          const t = timings[p];
          if(t) prayerMap[p] = parseTime(dateObj, t);
        });

        // Current/Next
        const now = new Date();
        let current = null, next = null;
        for(const p of PRAYERS_FOR_STATUS){
          const t = prayerMap[p];
          if(!t) continue;
          if(now >= t) current = p;
          else if(!next) next = p;
        }

        // Table
        el.tableBody.innerHTML = "";
        PRAYER_ORDER.forEach(p => {
          const time = timings[p];
          if(!time) return;
          const row = buildRow(p, time, p === current, p === next);
          el.tableBody.appendChild(row);
        });

        // Countdown
        if(countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
        if(next && prayerMap[next]) {
          el.nextName.textContent = next;
          const tick = () => el.countdown.textContent = hms(prayerMap[next] - new Date());
          tick();
          countdownTimer = setInterval(tick, 1000);
        } else {
          el.nextName.textContent = "—";
          el.countdown.textContent = "—";
        }

        // Progress bar
        updateProgressBar(prayerMap);
        if(progressTimer) { clearInterval(progressTimer); progressTimer = null; }
        progressTimer = setInterval(() => updateProgressBar(prayerMap), 30000);

        // Ramadan widget
        await updateRamadanWidget(hijri);

        // Footer meta
        el.meta.textContent = "Method: Muslim World League • School: Hanafi";
      } catch (e) {
        el.error.textContent = `Could not load timings. ${e.message}`;
        el.error.style.display = "block";
      }
    }

    // Load monthly calendar for the month of the selected date
    async function loadMonthlyCalendar(dateObj){
      try {
        const year = dateObj.getFullYear();
        const month = dateObj.getMonth() + 1; // 1-12
        const url = `https://api.aladhan.com/v1/calendarByAddress?address=${encodeURIComponent(ADDRESS)}&method=${METHOD}&school=${SCHOOL}&month=${month}&year=${year}`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`Calendar API ${res.status}`);
        const json = await res.json();
        const days = Array.isArray(json?.data) ? json.data : [];

        el.calendarTbody.innerHTML = "";
        const todayStr = `${pad(dateObj.getDate())}-${pad(month)}-${year}`;

        days.forEach(day => {
          const dReadable = day?.date?.readable || "";
          const dateHijri = day?.date?.hijri;
          const t = day?.timings || {};
          const tr = document.createElement("tr");
          if(day?.date?.gregorian?.date === todayStr) tr.classList.add("cal-today");

          const tdDate = document.createElement("td");
          tdDate.textContent = dReadable;

          const tdFajr = document.createElement("td"); tdFajr.textContent = cleanTime(t.Fajr);
          const tdDhuhr = document.createElement("td"); tdDhuhr.textContent = cleanTime(t.Dhuhr);
          const tdAsr = document.createElement("td"); tdAsr.textContent = cleanTime(t.Asr);
          const tdMaghrib = document.createElement("td"); tdMaghrib.textContent = cleanTime(t.Maghrib);
          const tdIsha = document.createElement("td"); tdIsha.textContent = cleanTime(t.Isha);

          tr.appendChild(tdDate);
          tr.appendChild(tdFajr);
          tr.appendChild(tdDhuhr);
          tr.appendChild(tdAsr);
          tr.appendChild(tdMaghrib);
          tr.appendChild(tdIsha);
          el.calendarTbody.appendChild(tr);
        });
      } catch (e) {
        // If calendar fails, keep page usable
        el.calendarTbody.innerHTML = `<tr><td colspan="6">Monthly calendar unavailable</td></tr>`;
      }
    }

    // Remove timezone suffixes like " (CET)"
    function cleanTime(s){
      if(!s || typeof s !== "string") return "—";
      return s.split(" ")[0]; // "HH:MM"
    }

    // Init and handlers
    (function init() {
      const today = new Date();
      el.dateInput.value = formatInputDate(today);
      loadTimingsForDate(today);
      loadMonthlyCalendar(today);
    })();

    el.dateInput.addEventListener("change", () => {
      if(!el.dateInput.value) return;
      const d = new Date(el.dateInput.value + "T00:00:00");
      loadTimingsForDate(d);
      loadMonthlyCalendar(d);
    });
  </script>
</body>
</html>
