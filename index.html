
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Prayer Times – Gosheim (Hanafi)</title>

  <!-- Static DARK THEME (no external CSS/JS) -->
  <style>
    /* ---------- Dark theme tokens (static) ---------- */
    :root {
      --brand: #3aa3ff;

      --bg: #000;          /* Page background */
      --text: #e5e7eb;        /* Primary text */
      --muted: #94a3b8;       /* Secondary text */

      --card-bg: #111827;     /* Cards / containers */
      --card-border: #1f2937; /* Borders */
      --shadow: 0 1px 2px rgba(0,0,0,.25);

      /* Table gray palette (dark-friendly) */
      --table-head-bg: #0f172a;        /* Very dark header */
      --table-head-text: #e5e7eb;      /* Header text */
      --table-row-border: #1f2937;     /* Row separators */
      --table-row-bg-odd: #141a26;     /* Zebra odd */
      --table-row-bg-even: #1a2130;    /* Zebra even */

      /* Accent pill */
      --accent-bg: #0e2a47;
      --accent-text: #cbe7ff;

      /* Status colors */
      --danger: #f87171;

      /* Row highlights */
      --hl-next-bg: #231c0d;
      --hl-next-border: #3a2f1f;
      --hl-current-bg: #0d2313;
      --hl-current-border: #1f3a29;

      /* Small chips */
      --chip-bg: #132041;
      --chip-text: #cbe7ff;
      --chip-border: #24304a;
    }

    /* ---------- Base layout ---------- */
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .container { width: 100%; max-width: 520px; margin: 0 auto; padding: 0 16px; }

    /* Top info bar (city, date, next prayer + countdown) */
    .info {
      background: var(--card-bg); border: 1px solid var(--card-border); border-radius: .6rem;
      box-shadow: var(--shadow); padding: .75rem 1rem; margin-top: 12px; margin-bottom: 8px;
    }
    .row { display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:.5rem; }
    .city { font-weight: 700; }
    .muted { color: var(--muted); }
    .pill {
      display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .6rem; border-radius:999px;
      background: var(--accent-bg); color: var(--accent-text); font-weight:600;
    }
    .countdown { font-size:.95rem; color: var(--muted); }

    /* Times card */
    .card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius:.6rem; box-shadow: var(--shadow); }

    /* Table (gray with zebra striping) */
    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: var(--table-head-bg); color: var(--table-head-text);
      padding: .75rem; text-align: left; border-bottom: 1px solid var(--table-row-border);
      font-weight: 700; letter-spacing: .02em;
    }
    tbody tr:nth-child(odd)  { background: var(--table-row-bg-odd); }
    tbody tr:nth-child(even) { background: var(--table-row-bg-even); }
    tbody td {
      padding: .75rem; border-bottom: 1px solid var(--table-row-border); color: var(--text);
    }
    .text-right   { text-align: right; }
    .fw-semibold  { font-weight: 600; }

    /* Row highlights (overlay on zebra rows) */
    .hl-next    { background: linear-gradient(to right, var(--hl-next-bg), var(--hl-next-bg)); border-left: 3px solid var(--hl-next-border); }
    .hl-current { background: linear-gradient(to right, var(--hl-current-bg), var(--hl-current-bg)); border-left: 3px solid var(--hl-current-border); }

    /* Small chip on the right side */
    .chip {
      display:inline-block; margin-left:.5rem; padding:.2rem .45rem; border-radius:999px;
      background: var(--chip-bg); color: var(--chip-text); border:1px solid var(--chip-border);
      font-size:.75rem; font-weight:700;
    }

    .danger { color: var(--danger); }
  </style>
</head>
<body>
  <main class="container">
    <!-- Top info (city, date, next prayer + countdown) -->
    <section class="info" aria-label="Today & next prayer">
      <div class="row">
        <div class="city" id="cityLabel">Gosheim, Germany</div>
        <div class="muted" id="dateLabel">Loading date…</div>
      </div>
      <div class="row" style="margin-top:.35rem;">
        <div class="pill">
          <span>Next:</span>
          <span id="nextPrayerName">—</span>
          <span id="nextPrayerTime" class="fw-semibold">—</span>
        </div>
        <div class="countdown" id="nextPrayerCountdown">Calculating…</div>
      </div>
    </section>

    <!-- Prayer times table -->
    <section class="card" aria-label="Prayer times">
      <table>
        <thead>
          <tr>
            <th>Prayer</th>
            <th class="text-right">Time</th>
          </tr>
        </thead>
        <tbody id="prayersBody">
          <tr><td colspan="2" class="text-right muted" style="padding:1rem;">Loading…</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    // ---- Preferred static settings (Gosheim, Germany, Hanafi, Diyanet 13) ----
    const state = {
      city: 'Gosheim',
      country: 'Germany',
      timezone: 'Europe/Berlin',
      method: 13,                  // Diyanet, Turkey
      school: 1,                   // Hanafi
      latitudeAdjustmentMethod: 3, // Angle Based
      midnightMode: 0              // Standard
    };

    const prayersOrder = [
      { key: 'Fajr',    label: 'Fajr'    },
      { key: 'Sunrise', label: 'Sunrise' },
      { key: 'Dhuhr',   label: 'Dhuhr'   },
      { key: 'Asr',     label: 'Asr'     },
      { key: 'Maghrib', label: 'Maghrib' },
      { key: 'Isha',    label: 'Isha'    }
    ];

    const cleanTime = t => (t || '').toString().split(' ')[0];

    function hhmmToToday(hhmm) {
      const [hh, mm] = cleanTime(hhmm).split(':').map(Number);
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
    }

    function formatCountdown(ms) {
      if (ms <= 0) return 'Started';
      const sec = Math.floor(ms / 1000);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return `${h}h ${m}m ${s}s`;
    }

    async function getTimingsByCity() {
      const base = 'https://api.aladhan.com/v1/timingsByCity';
      const url = `${base}?city=${encodeURIComponent(state.city)}&country=${encodeURIComponent(state.country)}`
        + `&method=${state.method}&school=${state.school}&timezonestring=${encodeURIComponent(state.timezone)}`
        + `&latitudeAdjustmentMethod=${state.latitudeAdjustmentMethod}&midnightMode=${state.midnightMode}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Aladhan HTTP ${res.status}`);
      const json = await res.json();
      if (!json?.data?.timings) throw new Error('Invalid API response payload');
      return json.data;
    }

    function computeNextPrayerLocally(timings) {
      const now = Date.now();
      for (const p of prayersOrder) {
        const t = hhmmToToday(timings[p.key]).getTime();
        if (t > now) return { name: p.label, time: cleanTime(timings[p.key]) };
      }
      return { name: 'Fajr (tomorrow)', time: '—' };
    }

    function renderTimetable(timings) {
      const tbody = document.getElementById('prayersBody');
      tbody.innerHTML = '';
      for (const p of prayersOrder) {
        const t = cleanTime(timings[p.key]);
        const tr = document.createElement('tr');
        tr.id = `row-${p.key}`;
        tr.innerHTML = `
          <td>${p.label}</td>
          <td class="text-right fw-semibold">
            ${t}
            <span class="chip" id="chip-${p.key}" style="display:none;"></span>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderMeta(dateObj) {
      document.getElementById('cityLabel').textContent = `${state.city}, ${state.country}`;
      document.getElementById('dateLabel').textContent = dateObj?.readable || '';
    }

    function startCountdown(targetHHMM) {
      const el = document.getElementById('nextPrayerCountdown');
      if (!targetHHMM || targetHHMM === '—') { el.textContent = '—'; return; }
      const target = hhmmToToday(targetHHMM);
      function tick() {
        const ms = target.getTime() - Date.now();
        el.textContent = 'Starts in ' + formatCountdown(ms);
        if (ms <= 0) { el.textContent = 'It’s time.'; clearInterval(timer); }
      }
      tick();
      const timer = setInterval(tick, 1000);
    }

    function highlightCurrentAndNext(timings, nextName) {
      // reset
      prayersOrder.forEach(p => {
        const row = document.getElementById(`row-${p.key}`);
        const chip = document.getElementById(`chip-${p.key}`);
        if (row) row.classList.remove('hl-current', 'hl-next');
        if (chip) { chip.style.display = 'none'; chip.textContent = ''; }
      });

      // current = last time <= now
      const now = Date.now();
      let currentKey = null;
      for (const p of prayersOrder) {
        const t = hhmmToToday(timings[p.key]).getTime();
        if (t <= now) currentKey = p.key; else break;
      }
      if (currentKey) {
        const row = document.getElementById(`row-${currentKey}`);
        const chip = document.getElementById(`chip-${currentKey}`);
        if (row) row.classList.add('hl-current');
        if (chip) { chip.style.display = 'inline-block'; chip.textContent = 'Now'; }
      }

      // next = computed name
      const match = prayersOrder.find(p => p.label.toLowerCase() === (nextName || '').toLowerCase());
      if (match) {
        const row = document.getElementById(`row-${match.key}`);
        const chip = document.getElementById(`chip-${match.key}`);
        if (row) row.classList.add('hl-next');
        if (chip) { chip.style.display = 'inline-block'; chip.textContent = 'Next'; }
      }
    }

    async function load() {
      const tbody = document.getElementById('prayersBody');
      tbody.innerHTML = `<tr><td colspan="2" class="text-right muted" style="padding:1rem;">Loading…</td></tr>`;
      document.getElementById('nextPrayerName').textContent = '—';
      document.getElementById('nextPrayerTime').textContent = '—';
      document.getElementById('nextPrayerCountdown').textContent = 'Calculating…';

      try {
        const data = await getTimingsByCity();
        renderTimetable(data.timings);
        renderMeta(data.date);

        const nextP = computeNextPrayerLocally(data.timings);
        document.getElementById('nextPrayerName').textContent = nextP.name;
        document.getElementById('nextPrayerTime').textContent = cleanTime(nextP.time);
        startCountdown(cleanTime(nextP.time));

        highlightCurrentAndNext(data.timings, nextP.name);
      } catch (err) {
        console.error('Load error:', err);
        tbody.innerHTML = `<tr><td colspan="2" class="text-right danger" style="padding:1rem;">
          Failed to load from API. ${err.message}</td></tr>`;
        document.getElementById('nextPrayerCountdown').textContent = '';
      }
    }

    // First render
    load();
  </script>
</body>
</html>
