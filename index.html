
<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Prayer Times – Gosheim (Hanafi)</title>

  <!-- Pure CSS, mobile-first, self-contained, with Dark Mode + Highlights -->
  <style>
    /* ---------- LIGHT theme defaults on :root ---------- */
    :root {
      --brand: #0b6fbe;

      --bg: #f8fafc;
      --text: #0f172a;
      --muted: #64748b;

      --card-bg: #ffffff;
      --card-border: #e5e7eb;
      --shadow: 0 1px 2px rgba(16,24,40,.08);

      --table-head-bg: #f1f5f9;
      --table-row-border: #e5e7eb;

      --pill-bg: #e6f2fd;
      --pill-text: #084f93;

      --badge-bg: #eef2ff;
      --badge-text: #1e40af;
      --badge-border: #e5e7eb;

      --btn-outline-text: var(--brand);
      --btn-outline-border: var(--brand);
      --btn-outline-bg: transparent;

      --btn-primary-bg: var(--brand);
      --btn-primary-text: #ffffff;
      --btn-primary-border: var(--brand);

      --input-bg: #ffffff;
      --input-text: var(--text);
      --input-border: #cbd5e1;

      --danger: #dc2626;

      /* New highlight tokens */
      --hl-current-bg: #e9ffe9;        /* soft green */
      --hl-current-border: #b5e7b5;
      --hl-current-text: #0b4d0b;

      --hl-next-bg: #fff6e5;           /* soft amber */
      --hl-next-border: #f4d7a8;
      --hl-next-text: #7a4b00;

      --chip-bg: #edf2ff;
      --chip-text: #1e3a8a;
      --chip-border: #c7d2fe;
    }

    /* ---------- System dark preference (initial) ---------- */
    @media (prefers-color-scheme: dark) {
      :root {
        --brand: #3aa3ff;

        --bg: #0b1220;
        --text: #e5e7eb;
        --muted: #94a3b8;

        --card-bg: #111827;
        --card-border: #1f2937;
        --shadow: 0 1px 2px rgba(0,0,0,.25);

        --table-head-bg: #162337;
        --table-row-border: #1f2937;

        --pill-bg: #0e2a47;
        --pill-text: #cbe7ff;

        --badge-bg: #132041;
        --badge-text: #cbe7ff;
        --badge-border: #24304a;

        --btn-outline-text: var(--brand);
        --btn-outline-border: var(--brand);
        --btn-outline-bg: transparent;

        --btn-primary-bg: var(--brand);
        --btn-primary-text: #0b1220;
        --btn-primary-border: var(--brand);

        --input-bg: #0b1220;
        --input-text: var(--text);
        --input-border: #24304a;

        --danger: #f87171;

        /* Dark highlight tokens */
        --hl-current-bg: #0d2313;
        --hl-current-border: #1f3a29;
        --hl-current-text: #a7f3d0;

        --hl-next-bg: #231c0d;
        --hl-next-border: #3a2f1f;
        --hl-next-text: #fde68a;

        --chip-bg: #132041;
        --chip-text: #cbe7ff;
        --chip-border: #24304a;
      }
    }

    /* ---------- Manual DARK override: apply on <html class="theme-dark"> ---------- */
    html.theme-dark {
      --brand: #3aa3ff;

      --bg: #0b1220;
      --text: #e5e7eb;
      --muted: #94a3b8;

      --card-bg: #111827;
      --card-border: #1f2937;
      --shadow: 0 1px 2px rgba(0,0,0,.25);

      --table-head-bg: #162337;
      --table-row-border: #1f2937;

      --pill-bg: #0e2a47;
      --pill-text: #cbe7ff;

      --badge-bg: #132041;
      --badge-text: #cbe7ff;
      --badge-border: #24304a;

      --btn-outline-text: var(--brand);
      --btn-outline-border: var(--brand);
      --btn-outline-bg: transparent;

      --btn-primary-bg: var(--brand);
      --btn-primary-text: #0b1220;
      --btn-primary-border: var(--brand);

      --input-bg: #0b1220;
      --input-text: var(--text);
      --input-border: #24304a;

      --danger: #f87171;

      --hl-current-bg: #0d2313;
      --hl-current-border: #1f3a29;
      --hl-current-text: #a7f3d0;

      --hl-next-bg: #231c0d;
      --hl-next-border: #3a2f1f;
      --hl-next-text: #fde68a;

      --chip-bg: #132041;
      --chip-text: #cbe7ff;
      --chip-border: #24304a;
    }

    /* ---------- Base layout ---------- */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; min-height: 100%;
      background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .container { width: 100%; max-width: 520px; margin: 0 auto; padding: 0 16px; }

    /* Header */
    .header {
      position: sticky; top: 0; z-index: 10;
      background: var(--card-bg); border-bottom: 1px solid var(--card-border);
      box-shadow: var(--shadow);
    }
    .bar { display: flex; align-items: center; justify-content: space-between; padding: .6rem 1rem; }
    .bar h1 { font-size: 1.05rem; margin: 0; font-weight: 700; color: var(--text); }
    .bar small { color: var(--muted); }
    .controls { display:flex; align-items:center; gap:.5rem; }

    .badge {
      display:inline-block; padding:.35rem .6rem; border-radius:999px;
      background: var(--badge-bg); color: var(--badge-text);
      font-weight:600; font-size:.85rem; border: 1px solid var(--badge-border);
    }

    .btn {
      display:inline-block; padding:.55rem .9rem;
      border-radius:.5rem; font-weight:600; text-decoration:none; cursor:pointer;
    }
    .btn-outline {
      color: var(--btn-outline-text);
      background: var(--btn-outline-bg);
      border: 1px solid var(--btn-outline-border);
    }
    .btn-primary {
      color: var(--btn-primary-text);
      background: var(--btn-primary-bg);
      border: 1px solid var(--btn-primary-border);
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: .6rem;
      box-shadow: var(--shadow);
    }
    .card-body { padding: 1rem; }
    .muted { color: var(--muted); }

    .table { width: 100%; border-collapse: collapse; font-size: 1.05rem; }
    .table thead th {
      text-align: left; background: var(--table-head-bg);
      padding:.75rem; border-bottom: 1px solid var(--table-row-border);
      color: var(--text);
    }
    .table td {
      padding:.75rem; border-bottom: 1px solid var(--table-row-border);
      color: var(--text);
    }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .fw-semibold { font-weight: 600; }

    .pill {
      display: inline-flex; align-items: center; gap: .5rem; border-radius: 999px;
      padding: .35rem .75rem; background: var(--pill-bg); color: var(--pill-text);
      font-weight: 600;
    }
    .countdown { font-size: .95rem; color: var(--muted); margin-top:.25rem; }

    .mb-0 { margin-bottom: 0; }
    .mb-2 { margin-bottom: .5rem; }
    .mb-3 { margin-bottom: 1rem; }
    .py-3 { padding-top: 1rem; padding-bottom: 1rem; }
    .mt-3 { margin-top: 1rem; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }

    .form-label { display:block; margin-bottom:.25rem; font-weight:600; color: var(--text); }
    .form-control, .form-select {
      width:100%; padding:.55rem .65rem; border-radius:.5rem;
      border:1px solid var(--input-border); background: var(--input-bg); color: var(--input-text);
    }
    .form-text { font-size:.85rem; color: var(--muted); margin-top:.25rem; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(15,23,42,.35); display: none; }
    .modal {
      position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
      background: var(--card-bg); border:1px solid var(--card-border); border-radius:.6rem;
      width: min(520px, calc(100% - 32px)); display: none; color: var(--text);
      box-shadow: var(--shadow);
    }
    .modal-header, .modal-footer { padding: .75rem 1rem; border-bottom: 1px solid var(--card-border); }
    .modal-footer { border-top: 1px solid var(--card-border); border-bottom: none; display:flex; justify-content:flex-end; gap:.5rem; }
    .modal-body { padding: 1rem; }
    .show-backdrop { display:block; }
    .show-modal { display:block; }

    .danger { color: var(--danger); }

    /* ---------- Row highlight styles ---------- */
    .hl-current {
      background: var(--hl-current-bg);
      border-left: 3px solid var(--hl-current-border);
    }
    .hl-next {
      background: var(--hl-next-bg);
      border-left: 3px solid var(--hl-next-border);
    }
    .chip {
      display:inline-block; margin-left:.5rem; padding:.2rem .45rem; border-radius:999px;
      background: var(--chip-bg); color: var(--chip-text); border:1px solid var(--chip-border);
      font-size:.75rem; font-weight:700;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="bar container">
      <div>
        <h1 class="mb-0">Prayer Times – Gosheim</h1>
        <small class="muted" id="dateLabel">Loading…</small>
      </div>
      <div class="controls">
        <span class="badge" id="tzBadge">Europe/Berlin</span>
        <button class="btn btn-outline" id="toggleThemeBtn" aria-label="Toggle dark mode">Dark</button>
      </div>
    </div>
  </header>

  <!-- MAIN: prayer times table FIRST -->
  <main class="container py-3">
    <div class="card mb-3" id="prayersCard">
      <div class="card-body">
        <div class="row mb-2">
        
          <span class="pill" aria-live="polite">
            <span>Next:</span>
            <span id="nextPrayerName">—</span>
            <span id="nextPrayerTime" class="fw-semibold">—</span>
          </span>
        
          <div class="countdown" id="nextPrayerCountdown">Calculating…</div>
          
           
        </div>

        <table class="table" aria-label="Prayer times">
          <thead>
            <tr>
              <th>Prayer</th>
              <th class="text-right">Time</th>
            </tr>
          </thead>
          <tbody id="prayersBody">
            <tr><td colspan="2" class="text-center muted py-3">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- OTHER INFORMATION BELOW THE TABLE -->
    <section class="mb-3" id="belowTableInfo" aria-label="Next prayer and controls">
      <div class="row mb-3">
        
        <div style="display:flex; gap:.5rem;">
          <button class="btn btn-outline" id="refreshBtn">Refresh</button>
          <button class="btn btn-primary" id="openSettingsBtn">Settings</button>
        </div>
      </div>
  <div class="fw-semibold">Gosheim, Germany</div>
            <div class="muted" id="methodLabel">Method: Moonsighting Committee (15), School: Hanafi</div>
      <p class="muted">
        Times provided by Aladhan.com; small differences vs. local mosque may occur due to local tuning.
      </p>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop"></div>
  <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsModalLabel">
    <div class="modal-header">
      <h5 id="settingsModalLabel" style="margin:0;">Prayer Time Settings</h5>
      <button class="btn btn-outline" id="modalCloseBtn">Close</button>
    </div>
    <div class="modal-body">
      <form id="settingsForm">
        <div class="mb-3">
          <label class="form-label">City</label>
          <input type="text" class="form-control" id="cityInput" value="Gosheim">
        </div>

        <div class="mb-3">
          <label class="form-label">Country</label>
          <input type="text" class="form-control" id="countryInput" value="Germany">
        </div>

        <div class="mb-3">
          <label class="form-label">Timezone (IANA)</label>
          <input type="text" class="form-control" id="tzInput" value="Europe/Berlin">
          <div class="form-text">Example: Europe/Berlin</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Calculation Method</label>
          <select class="form-select" id="methodSelect">
            <option value="15" selected>Moonsighting Committee Worldwide (15)</option>
            <option value="13">Diyanet, Turkey (13)</option>
            <option value="3">Muslim World League (3)</option>
            <option value="2">ISNA – North America (2)</option>
            <option value="5">Egypt (5)</option>
            <option value="4">Umm Al‑Qura, Makkah (4)</option>
            <option value="12">UOIF, France (12)</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">School (Asr)</label>
          <select class="form-select" id="schoolSelect">
            <option value="1" selected>Hanafi (1)</option>
            <option value="0">Shafi (0)</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">High Latitude Adjustment</label>
          <select class="form-select" id="latAdjSelect">
            <option value="3" selected>Angle Based (3)</option>
            <option value="1">Middle of the Night (1)</option>
            <option value="2">One Seventh (2)</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Midnight Mode</label>
          <select class="form-select" id="midnightSelect">
            <option value="0" selected>Standard (0)</option>
            <option value="1">Jafari (1)</option>
          </select>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline" id="modalCancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save & Reload</button>
        </div>
      </form>
    </div>
  </div>

  <!-- App JS -->
  <script>
    /* ---------- Theme handling (toggle on <html>) ---------- */
    const rootEl = document.documentElement; // <html>
    const toggleBtn = document.getElementById('toggleThemeBtn');

    function applySavedTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') {
        rootEl.classList.add('theme-dark');
        toggleBtn.textContent = 'Light';
        toggleBtn.setAttribute('aria-label', 'Switch to light mode');
      } else if (saved === 'light') {
        rootEl.classList.remove('theme-dark');
        toggleBtn.textContent = 'Dark';
        toggleBtn.setAttribute('aria-label', 'Switch to dark mode');
      } else {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        rootEl.classList.toggle('theme-dark', prefersDark);
        toggleBtn.textContent = prefersDark ? 'Light' : 'Dark';
        toggleBtn.setAttribute('aria-label', prefersDark ? 'Switch to light mode' : 'Switch to dark mode');
      }
    }
    applySavedTheme();

    toggleBtn.addEventListener('click', () => {
      const isDark = rootEl.classList.toggle('theme-dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      toggleBtn.textContent = isDark ? 'Light' : 'Dark';
      toggleBtn.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
    });

    /* ---------- Defaults (Gosheim, Germany, Hanafi) ---------- */
    const state = {
      city: 'Gosheim',
      country: 'Germany',
      method: 15,                  // Moonsighting Committee Worldwide
      school: 1,                   // Hanafi
      timezone: 'Europe/Berlin',
      latitudeAdjustmentMethod: 3, // Angle Based
      midnightMode: 0              // Standard
    };

    const prayersOrder = [
      { key: 'Fajr', label: 'Fajr' },
      { key: 'Sunrise', label: 'Sunrise' },
      { key: 'Dhuhr', label: 'Dhuhr' },
      { key: 'Asr', label: 'Asr' },
      { key: 'Maghrib', label: 'Maghrib' },
      { key: 'Isha', label: 'Isha' }
    ];

    const cleanTime = t => (t || '').toString().split(' ')[0];

    function hhmmToToday(hhmm) {
      const [hh, mm] = cleanTime(hhmm).split(':').map(Number);
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
    }

    function formatCountdown(ms) {
      if (ms <= 0) return 'Started';
      const sec = Math.floor(ms / 1000);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return `${h}h ${m}m ${s}s`;
    }

    async function getTimingsByCity() {
      const base = 'https://api.aladhan.com/v1/timingsByCity';
      const url = `${base}?city=${encodeURIComponent(state.city)}&country=${encodeURIComponent(state.country)}`
        + `&method=${state.method}&school=${state.school}&timezonestring=${encodeURIComponent(state.timezone)}`
        + `&latitudeAdjustmentMethod=${state.latitudeAdjustmentMethod}&midnightMode=${state.midnightMode}`;

      console.log('Fetching:', url);
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Aladhan HTTP ${res.status}`);
      const json = await res.json();
      if (!json || !json.data || !json.data.timings) throw new Error('Invalid API response payload');
      return json.data;
    }

    function computeNextPrayerLocally(timings) {
      const now = Date.now();
      for (const p of prayersOrder) {
        const t = hhmmToToday(timings[p.key]).getTime();
        if (t > now) return { name: p.label, time: cleanTime(timings[p.key]) };
      }
      return { name: 'Fajr (tomorrow)', time: '—' };
    }

    function renderTimetable(timings) {
      const tbody = document.getElementById('prayersBody');
      tbody.innerHTML = '';
      for (const p of prayersOrder) {
        const t = cleanTime(timings[p.key]);
        const tr = document.createElement('tr');
        tr.id = `row-${p.key}`;
        tr.innerHTML = `<td>${p.label}</td>
                        <td class="text-right fw-semibold">
                          ${t}
                          <span class="chip d-none" id="chip-${p.key}"></span>
                        </td>`;
        tbody.appendChild(tr);
      }
    }

    function renderMeta(meta, dateObj) {
      document.getElementById('dateLabel').textContent = dateObj.readable || '';
      const methodName = (meta && meta.method && meta.method.name) ? meta.method.name : '—';
      const methodId   = (meta && meta.method && 'id' in meta.method) ? meta.method.id : state.method;
      document.getElementById('methodLabel').textContent =
        `Method: ${methodName} (${methodId}), School: ${state.school === 1 ? 'Hanafi' : 'Shafi'}`;
      document.getElementById('tzBadge').textContent = state.timezone;
    }

    function startCountdown(targetHHMM) {
      const el = document.getElementById('nextPrayerCountdown');
      if (!targetHHMM || targetHHMM === '—') { el.textContent = '—'; return; }
      const target = hhmmToToday(targetHHMM);
      function tick() {
        const ms = target.getTime() - Date.now();
        el.textContent = 'Starts in ' + formatCountdown(ms);
        if (ms <= 0) { el.textContent = 'It’s time.'; clearInterval(timer); }
      }
      tick();
      const timer = setInterval(tick, 1000);
    }

    // --- Highlight current & next ---
    function highlightCurrentAndNext(timings, nextName) {
      // Clear any previous highlights
      prayersOrder.forEach(p => {
        const row = document.getElementById(`row-${p.key}`);
        const chip = document.getElementById(`chip-${p.key}`);
        if (row) { row.classList.remove('hl-current', 'hl-next'); }
        if (chip) { chip.classList.add('d-none'); chip.textContent = ''; }
      });

      // Determine "current": last prayer time <= now (for today)
      const now = Date.now();
      let currentKey = null;
      for (const p of prayersOrder) {
        const t = hhmmToToday(timings[p.key]).getTime();
        if (t <= now) currentKey = p.key; else break;
      }

      // Apply "current" highlight
      if (currentKey) {
        const row = document.getElementById(`row-${currentKey}`);
        const chip = document.getElementById(`chip-${currentKey}`);
        if (row) row.classList.add('hl-current');
        if (chip) { chip.classList.remove('d-none'); chip.textContent = 'Now'; }
      }

      // Apply "next" highlight (based on nextName string)
      const nextKey = (nextName || '').trim();
      if (nextKey) {
        // Map display labels to keys (same names here except Dhuhr vs Dhuhr etc.)
        const match = prayersOrder.find(p => p.label.toLowerCase() === nextKey.toLowerCase());
        if (match) {
          const row = document.getElementById(`row-${match.key}`);
          const chip = document.getElementById(`chip-${match.key}`);
          if (row) row.classList.add('hl-next');
          if (chip) { chip.classList.remove('d-none'); chip.textContent = 'Next'; }
        }
      }
    }

    async function load() {
      const tbody = document.getElementById('prayersBody');
      tbody.innerHTML = `<tr><td colspan="2" class="text-center muted py-3">Loading…</td></tr>`;
      document.getElementById('nextPrayerName').textContent = '—';
      document.getElementById('nextPrayerTime').textContent = '—';
      document.getElementById('nextPrayerCountdown').textContent = 'Calculating…';

      try {
        const data = await getTimingsByCity();
        renderTimetable(data.timings);
        renderMeta(data.meta, data.date);

        const nextP = computeNextPrayerLocally(data.timings);
        document.getElementById('nextPrayerName').textContent = nextP.name;
        document.getElementById('nextPrayerTime').textContent = cleanTime(nextP.time);
        startCountdown(cleanTime(nextP.time));

        // Highlight rows
        highlightCurrentAndNext(data.timings, nextP.name);
      } catch (err) {
        console.error('Load error:', err);
        tbody.innerHTML = `<tr><td colspan="2" class="text-center danger" style="padding:1rem;">
          Failed to load from API. ${err.message}. Check network or parameters.</td></tr>`;
        document.getElementById('nextPrayerCountdown').textContent = '';
      }
    }

    // Modal (plain JS)
    const modal = document.getElementById('settingsModal');
    const backdrop = document.getElementById('modalBackdrop');

    function openModal() {
      backdrop.classList.add('show-backdrop');
      modal.classList.add('show-modal');
    }
    function closeModal() {
      modal.classList.remove('show-modal');
      backdrop.classList.remove('show-backdrop');
    }

    document.getElementById('openSettingsBtn').addEventListener('click', openModal);
    document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
    document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);

    document.getElementById('settingsForm').addEventListener('submit', (e) => {
      e.preventDefault();
      state.city = document.getElementById('cityInput').value.trim() || state.city;
      state.country = document.getElementById('countryInput').value.trim() || state.country;
      state.timezone = document.getElementById('tzInput').value.trim() || state.timezone;
      state.method = parseInt(document.getElementById('methodSelect').value, 10);
      state.school = parseInt(document.getElementById('schoolSelect').value, 10);
      state.latitudeAdjustmentMethod = parseInt(document.getElementById('latAdjSelect').value, 10);
      state.midnightMode = parseInt(document.getElementById('midnightSelect').value, 10);

      closeModal();
      load();
    });

    document.getElementById('refreshBtn').addEventListener('click', load);

    // First load
    applySavedTheme();
    load();
  </script>
</body>
</html>
