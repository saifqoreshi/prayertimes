<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prayer Times – Gosheim, Germany</title>
<style>
:root{
  --bg:#0b0f14; --card:#111722; --text:#e6edf3; --muted:#9fb0c0;
  --accent:#3aa3ff; --accent2:#25c2a0; --border:#233044; --radius:12px;
  --shadow:0 6px 18px rgba(0,0,0,0.35);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
.app{max-width:740px;margin:0 auto;padding:12px 16px 24px;}
header{position:sticky;top:0;background:var(--card);padding:10px;border-bottom:1px solid var(--border);box-shadow:var(--shadow);z-index:2;}
header h1{margin:0;font-size:1rem;}
header .sub{font-size:0.9rem;color:var(--muted);margin-top:4px;}
.error{display:none;color:#ff788a;background:rgba(255,77,109,0.12);border:1px solid #ff4d6d;border-radius:10px;padding:8px;margin:10px 0;text-align:center;font-size:0.9rem;}
.date-nav{display:flex;justify-content:center;align-items:center;gap:8px;margin:12px 0;}
.date-nav button{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-size:1rem;cursor:pointer;}
.date-nav input[type="date"]{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px;font-size:0.9rem;text-align:center;}

.next-row{display:flex;justify-content:space-between;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:12px;box-shadow:var(--shadow);}
.next-row .next-prayer{text-align:left;font-weight:600;}
.next-row .countdown{text-align:right;font-weight:600;}
.next-row .label{font-size:0.85rem;color:var(--muted);}

table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:14px;overflow:hidden;}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:center;font-size:0.88rem;}
th{color:var(--muted);background:#0f1623;}
tr:last-child td{border-bottom:none;}

/* Only color and font-weight adjustments — removed any background/border highlight */
.row.current td:nth-child(2){color:var(--accent);font-weight:700;}
.row.next td:nth-child(2){color:var(--accent2);font-weight:700;}
.indicator{display:block;font-size:0.72rem;margin-top:4px;color:var(--muted);}

/* make the small indicator slightly tinted text so it remains readable on dark background */
.row.current .indicator{color:var(--accent);}
.row.next .indicator{color:var(--accent2);}

.ramadan-widget{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-top:14px;text-align:center;box-shadow:var(--shadow);}
.ramadan-widget strong{color:var(--accent2);}
.ramadan-widget .sub{color:var(--muted);font-size:0.9rem;}

.calendar-toggle{text-align:center;margin:12px 0;}
.calendar-toggle button{background:var(--card);color:var(--text);border:2px solid var(--accent);border-radius:var(--radius);padding:10px 18px;cursor:pointer;font-size:0.95rem;font-weight:600;box-shadow:var(--shadow);transition:0.25s;}
.calendar-toggle button:hover{background:var(--accent);color:#fff;border-color:var(--accent2);}
.calendar-container{display:none;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-top:16px;box-shadow:var(--shadow);max-height:480px;overflow:auto;}
.calendar-controls{display:flex;justify-content:center;gap:6px;margin-bottom:8px;flex-wrap:wrap;}
.calendar-controls select,.calendar-controls button{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:0.85rem;cursor:pointer;}
.calendar-table{width:100%;border-collapse:collapse;}
.calendar-table th,.calendar-table td{padding:8px;border-bottom:1px solid var(--border);font-size:0.82rem;text-align:center;}
.calendar-table th{color:var(--muted);background:#0f1623;}
.calendar-table tr:last-child td{border-bottom:none;}
.cal-today{background:rgba(58,163,255,0.12);font-weight:700;}
.calendar-legend{font-size:0.75rem;color:var(--muted);text-align:center;margin-top:4px;}

footer{text-align:center;margin-top:16px;padding-bottom:8px;}
footer .powered{font-size:0.7rem;color:var(--muted);}
footer .meta{font-size:0.6rem;color:#6b7890;margin-top:4px;}
@media (max-width:420px){
  th,td{padding:8px;font-size:0.82rem;}
  .date-nav button{padding:8px;}
}
</style>
</head>
<body>
<div class="app">
<header>
  <h1>Prayer times for Gosheim, Germany</h1>
  <div class="sub" id="gregorian">—</div>
  <div class="sub" id="hijri">—</div>
</header>

<div id="error" class="error" role="alert"></div>

<div class="date-nav" aria-label="Datum Navigation">
  <button id="prevDay" aria-label="Vorheriger Tag">&lt;</button>
  <input type="date" id="dateInput" aria-label="Datum auswählen" />
  <button id="nextDay" aria-label="Nächster Tag">&gt;</button>
</div>

<div class="next-row" aria-live="polite">
  <div>
    <span class="label">Next prayer</span>
    <div class="next-prayer" id="nextName">—</div>
  </div>
  <div>
    <span class="label">Countdown</span>
    <div class="countdown" id="countdown">—</div>
  </div>
</div>

<table aria-label="Prayer times">
  <thead><tr><th>Prayer</th><th>Time &amp; Status</th></tr></thead>
  <tbody id="tableBody"></tbody>
</table>

<div class="ramadan-widget" aria-live="polite">
  <div><strong>Days until Ramadan:</strong> <span id="ramadanCountdown">—</span></div>
  <div class="sub" id="ramadanDate">—</div>
</div>

<div class="calendar-toggle">
  <button id="toggleCalendar">Show Monthly Calendar</button>
</div>

<div class="calendar-container" id="calendarContainer">
  <div class="calendar-controls">
    <select id="monthSelect" aria-label="Monat wählen"></select>
    <select id="yearSelect" aria-label="Jahr wählen"></select>
    <button id="loadCalendar">Load</button>
  </div>
  <table class="calendar-table" id="calendarTable">
    <thead>
      <tr><th>Datum</th><th>Fajr</th><th>Dhuhr</th><th>Asr</th><th>Maghrib</th><th>Isha</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="calendar-legend">Zeiten im 12-Stunden-Format (keine Zeitzone angezeigt)</div>
</div>

<footer>
  <div class="powered">Powered by AlAdhan API</div>
  <div class="meta" id="meta">Method: Muslim World League • School: Hanafi</div>
</footer>
</div>

<script>
/* Configuration */
const ADDRESS = "Gosheim, Germany";
const METHOD = "3";
const SCHOOL = "1";

/* DOM elements */
const el = {
  tableBody: document.getElementById("tableBody"),
  gregorian: document.getElementById("gregorian"),
  hijri: document.getElementById("hijri"),
  nextName: document.getElementById("nextName"),
  countdown: document.getElementById("countdown"),
  dateInput: document.getElementById("dateInput"),
  ramadanCountdown: document.getElementById("ramadanCountdown"),
  ramadanDate: document.getElementById("ramadanDate"),
  meta: document.getElementById("meta"),
  error: document.getElementById("error"),
  toggleBtn: document.getElementById("toggleCalendar"),
  calContainer: document.getElementById("calendarContainer"),
  calBody: document.querySelector("#calendarTable tbody"),
  monthSelect: document.getElementById("monthSelect"),
  yearSelect: document.getElementById("yearSelect"),
  loadBtn: document.getElementById("loadCalendar"),
  prevDay: document.getElementById("prevDay"),
  nextDay: document.getElementById("nextDay"),
  toggleCalendar: document.getElementById("toggleCalendar")
};

const PRAYER_ORDER = ["Fajr","Sunrise","Dhuhr","Asr","Maghrib","Isha"];
const PRAYERS_FOR_STATUS = ["Fajr","Dhuhr","Asr","Maghrib","Isha"];
const MONTHS_DE = ["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];

/* Utilities */
function pad(n){ return String(n).padStart(2,"0"); }
function formatAPIDate(d){ return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}`; }
function formatInputDateISO(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function stripTZ(s){ return !s ? "—" : s.split(" ")[0]; } // removes trailing timezone text if present
function toAmPm(t){
  if(!t || t==="—") return "—";
  const [h,m] = t.split(":").map(Number);
  const hh = (h % 12) || 12;
  return hh + ":" + pad(m) + (h >= 12 ? " PM" : " AM");
}
function parseTime(baseDate, timeStr){
  const [h,m] = timeStr.split(":").map(Number);
  const d = new Date(baseDate);
  d.setHours(h, m, 0, 0);
  return d;
}
function hms(ms){
  if(ms < 0) ms = 0;
  const s = Math.floor(ms/1000), h = Math.floor(s/3600), m = Math.floor((s % 3600)/60), sec = s % 60;
  return pad(h) + ":" + pad(m) + ":" + pad(sec);
}

/* Format a Date to German full readable like: Sonntag, 7. Dezember 2025 */
function formatDateGermanLong(d){
  try{
    return d.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  }catch(e){
    return d.toLocaleDateString('de-DE');
  }
}

/* Format a Date to dd.MM.yyyy */
function formatDateGermanShort(d){
  return pad(d.getDate()) + "." + pad(d.getMonth()+1) + "." + d.getFullYear();
}

/* Build a table row for prayer name/time */
function buildRow(name, time24, isCurrent, isNext){
  const tr = document.createElement("tr");
  tr.className = "row" + (isCurrent ? " current" : "") + (isNext ? " next" : "");
  const td1 = document.createElement("td");
  td1.textContent = name;
  const td2 = document.createElement("td");
  td2.textContent = toAmPm(time24);
  if(isCurrent) td2.innerHTML += `<span class="indicator">Current</span>`;
  else if(isNext) td2.innerHTML += `<span class="indicator">Next</span>`;
  tr.append(td1, td2);
  return tr;
}

/* Update Ramadan widget - show only Gregorian start date (German) and days until */
async function updateRamadanWidget(hijri){
  try{
    // find the next Ramadan's Gregorian start by converting 1-9-(year) hijri to gregorian via API.
    const hijriYear = hijri && hijri.year ? parseInt(hijri.year, 10) : (new Date()).getFullYear();
    // decide target Hijri year: if current month < 9, target is current hijri year; else next hijri year
    const currentHijriMonthNum = hijri && hijri.month && hijri.month.number ? parseInt(hijri.month.number,10) : null;
    let targetHijri = hijriYear;
    if(currentHijriMonthNum !== null){
      if(currentHijriMonthNum > 9) targetHijri = hijriYear + 1;
      // if month is 9 but day >1 we'd still want next? keep simple: if month>=9 and day>1 -> next
      else if(currentHijriMonthNum === 9 && hijri.day && parseInt(hijri.day,10) > 1) targetHijri = hijriYear + 1;
    }

    const resp = await fetch(`https://api.aladhan.com/v1/hToG?date=1-9-${targetHijri}`);
    const body = await resp.json();
    const g = (body && body.data && body.data.gregorian && body.data.gregorian.date) ? body.data.gregorian.date : null;
    if(!g){
      el.ramadanCountdown.textContent = "—";
      el.ramadanDate.textContent = "Ramadan start date unavailable";
      return;
    }
    // API returns gregorian.date in format dd-mm-yyyy
    const [gd, gm, gy] = g.split("-");
    const ramG = new Date(`${gy}-${gm}-${gd}T00:00:00`);
    const diffDays = Math.ceil((ramG - new Date()) / 86400000);
    el.ramadanCountdown.textContent = diffDays > 0 ? diffDays : diffDays === 0 ? "Heute" : "Bereits begonnen";
    // Show only Gregorian date in German short format, no Hijri string
    el.ramadanDate.textContent = `Start: ${formatDateGermanShort(ramG)}`;
  }catch(err){
    el.ramadanCountdown.textContent = "—";
    el.ramadanDate.textContent = "Ramadan countdown unavailable";
  }
}

/* Load daily timings and render */
let countdownTimer = null;
async function loadDaily(d){
  try{
    el.error.style.display = "none";
    const apiDate = formatAPIDate(d);
    const url = `https://api.aladhan.com/v1/timingsByAddress/${apiDate}?address=${encodeURIComponent(ADDRESS)}&method=${METHOD}&school=${SCHOOL}`;
    const resp = await fetch(url);
    const body = await resp.json();
    if(!body || !body.data){
      throw new Error("No data returned from API");
    }
    const data = body.data;
    const timings = data.timings || {};
    const dateInfo = data.date || {};

    // Build gregorian display from returned gregorian fields for correct date names
    if(dateInfo.gregorian && dateInfo.gregorian.day){
      const g = dateInfo.gregorian;
      const gDate = new Date(`${g.year}-${String(g.month.number).padStart(2,'0')}-${String(g.day).padStart(2,'0')}T00:00:00`);
      el.gregorian.textContent = formatDateGermanLong(gDate);
    } else {
      el.gregorian.textContent = dateInfo.readable || "—";
    }

    // Hijri info for showing month/day text only
    const hijri = dateInfo.hijri || {};
    el.hijri.textContent = hijri && hijri.month ? `Hijri: ${hijri.day} ${hijri.month.en} ${hijri.year}` : "Hijri: —";

    // Map prayer times (strip tz)
    const tMap = {};
    PRAYER_ORDER.forEach(p => {
      const t = stripTZ(timings[p]);
      if(t !== "—") tMap[p] = parseTime(d, t);
    });

    const now = new Date();
    let currentName = null, nextName = null;

    for(const p of PRAYERS_FOR_STATUS){
      const t = tMap[p];
      if(!t) continue;
      if(now >= t) currentName = p;
      else if(!nextName) nextName = p;
    }

    // If no next (e.g. after Isha), fetch tomorrow's Fajr and set next to Fajr
    let nextIsTomorrow = false;
    if(!nextName){
      const tomorrow = new Date(d);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const resp2 = await fetch(`https://api.aladhan.com/v1/timingsByAddress/${formatAPIDate(tomorrow)}?address=${encodeURIComponent(ADDRESS)}&method=${METHOD}&school=${SCHOOL}`);
      const body2 = await resp2.json();
      const t2 = body2 && body2.data && body2.data.timings && stripTZ(body2.data.timings.Fajr);
      if(t2 && t2 !== "—"){
        nextName = "Fajr";
        nextIsTomorrow = true;
        // keep a mapping for tomorrow fajr time to display countdown properly
        tMap["Fajr_tomorrow"] = parseTime(tomorrow, t2);
      }
    }

    // Render table rows
    el.tableBody.innerHTML = "";
    PRAYER_ORDER.forEach(p => {
      const raw = stripTZ(timings[p]);
      if(raw === "—") return;
      const isCurrent = p === currentName;
      const isNext = p === nextName;
      el.tableBody.appendChild(buildRow(p, raw, isCurrent, isNext));
    });

    // Countdown handling
    if(countdownTimer) clearInterval(countdownTimer);
    if(nextName){
      el.nextName.textContent = nextIsTomorrow ? `${nextName} (tomorrow)` : nextName;
      const targetTime = nextIsTomorrow ? tMap["Fajr_tomorrow"] : tMap[nextName];
      const tick = () => {
        const diff = targetTime - new Date();
        el.countdown.textContent = hms(diff);
      };
      tick();
      countdownTimer = setInterval(tick, 1000);
    } else {
      el.nextName.textContent = "—";
      el.countdown.textContent = "—";
    }

    el.meta.textContent = "Method: Muslim World League • School: Hanafi";
    updateRamadanWidget(hijri);

  }catch(e){
    el.error.textContent = `Could not load timings. ${e.message || e}`;
    el.error.style.display = "block";
    el.tableBody.innerHTML = "";
    el.nextName.textContent = "—";
    el.countdown.textContent = "—";
  }
}

/* Populate month/year selects with German month names */
function populateMonthYearSelectors(){
  const now = new Date();
  MONTHS_DE.forEach((name, i) => {
    const opt = document.createElement("option");
    opt.value = i + 1;
    opt.textContent = name;
    if(i === now.getMonth()) opt.selected = true;
    el.monthSelect.appendChild(opt);
  });
  for(let y = now.getFullYear() - 1; y <= now.getFullYear() + 1; y++){
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    if(y === now.getFullYear()) opt.selected = true;
    el.yearSelect.appendChild(opt);
  }
}

/* Load monthly calendar and display dates in German short format dd.MM.yyyy */
async function loadMonthlyData(month, year){
  try{
    const r = await fetch(`https://api.aladhan.com/v1/calendarByAddress?address=${encodeURIComponent(ADDRESS)}&method=${METHOD}&school=${SCHOOL}&month=${month}&year=${year}`);
    const body = await r.json();
    const days = body && body.data ? body.data : [];
    el.calBody.innerHTML = "";
    const today = new Date();
    days.forEach(day => {
      const tr = document.createElement("tr");
      const gr = day.date.gregorian;
      const grDate = new Date(`${gr.year}-${String(gr.month.number).padStart(2,'0')}-${String(gr.day).padStart(2,'0')}T00:00:00`);
      // highlight today's row
      if(gr.day == today.getDate() && gr.month.number == today.getMonth() + 1 && gr.year == today.getFullYear()) tr.classList.add("cal-today");
      const t = day.timings || {};
      // times already contain timezone suffixs like "05:30 (CET)" so strip them
      const cells = [
        formatDateGermanShort(grDate),
        stripTZ(t.Fajr),
        stripTZ(t.Dhuhr),
        stripTZ(t.Asr),
        stripTZ(t.Maghrib),
        stripTZ(t.Isha)
      ];
      cells.forEach(c => {
        const td = document.createElement("td");
        td.textContent = c;
        tr.appendChild(td);
      });
      el.calBody.appendChild(tr);
    });
  }catch(err){
    el.calBody.innerHTML = "<tr><td colspan='6'>Monthly calendar unavailable</td></tr>";
  }
}

/* Event wiring */
el.toggleBtn.addEventListener("click", () => {
  const show = el.calContainer.style.display !== "block";
  el.calContainer.style.display = show ? "block" : "none";
  el.toggleBtn.textContent = show ? "Hide Monthly Calendar" : "Show Monthly Calendar";
});

el.loadBtn.addEventListener("click", () => {
  loadMonthlyData(parseInt(el.monthSelect.value,10), parseInt(el.yearSelect.value,10));
});

el.prevDay.addEventListener("click", () => {
  if(!el.dateInput.value) return;
  const d = new Date(el.dateInput.value + "T00:00:00");
  d.setDate(d.getDate() - 1);
  el.dateInput.value = formatInputDateISO(d);
  loadDaily(d);
});

el.nextDay.addEventListener("click", () => {
  if(!el.dateInput.value) return;
  const d = new Date(el.dateInput.value + "T00:00:00");
  d.setDate(d.getDate() + 1);
  el.dateInput.value = formatInputDateISO(d);
  loadDaily(d);
});

el.dateInput.addEventListener("change", () => {
  if(el.dateInput.value) loadDaily(new Date(el.dateInput.value + "T00:00:00"));
});

/* Initialize */
populateMonthYearSelectors();
const today = new Date();
el.dateInput.value = formatInputDateISO(today);
loadDaily(today);
loadMonthlyData(today.getMonth() + 1, today.getFullYear());
</script>
</body>
</html>
